<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>The Classics — Library + Ten-Year Plan</title>

  <!-- Neo-brutal newspaper fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; } /* no horizontal scroll */
    body { margin: 0; }
    img, svg { display: block; max-width: 100%; }
    button, input, select, textarea { font: inherit; }
    a { color: inherit; }

    /* ===== Neo-brutal newspaper theme (B/W, hard edges) ===== */
    :root{
      --paper:#fff;
      --ink:#000;
      --ink2:#111;
      --muted:#444;
      --border:2px solid var(--ink);
      --borderThin:1px solid var(--ink);
      --shadow:8px 8px 0 var(--ink);
      --shadowSm:5px 5px 0 var(--ink);
      --shadowXs:3px 3px 0 var(--ink);
      --gap:16px;
      --max:1200px;
      --radius:0px; /* HARD EDGES */
    }

    body{
      background:var(--paper);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.25;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:18px;
      overflow-x: hidden;
    }

    /* Masthead */
    header.masthead{
      border-top:6px solid var(--ink);
      border-bottom:3px solid var(--ink);
      padding:14px 0 12px 0;
      margin-bottom:16px;
    }
    .mast-top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:clamp(26px,3vw,44px);
      line-height:1;
      text-transform:uppercase;
    }
    .dateline{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:600;
      font-size:14px;
      color:var(--ink2);
      text-transform:uppercase;
      letter-spacing:0.06em;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .rule{ height:1px; background:var(--ink); margin-top:10px; }
    .subhead{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      border:var(--borderThin);
      padding:6px 10px;
      background:#fff;
      box-shadow:var(--shadowXs);
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      color:var(--ink);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* Progress badge popup wrapper */
    .progressBadgeWrap{
      position:relative;
      display:inline-block;
    }
    .progressBadgeWrap .badge{
      cursor:pointer;
    }
    .progressPopup{
      display:none;
      position:absolute;
      top:100%;
      right:0;
      margin-top:8px;
      background:#fff;
      border:var(--border);
      box-shadow:var(--shadow);
      padding:12px;
      min-width:260px;
      max-width:360px;
      z-index:1000;
    }
    .progressPopup.show{
      display:block;
    }
    .progressPopupTitle{
      font-weight:900;
      font-size:13px;
      letter-spacing:0.06em;
      text-transform:uppercase;
      margin-bottom:10px;
      border-bottom:var(--borderThin);
      padding-bottom:8px;
    }
    .progressPopupRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:6px 0;
      border-bottom:var(--borderThin);
    }
    .progressPopupRow:last-child{
      border-bottom:none;
    }
    .progressPopupName{
      font-weight:600;
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
    }
    .progressPopupScore{
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .progressPopupBar{
      width:60px;
      height:8px;
      border:var(--borderThin);
      background:#fff;
      position:relative;
    }
    .progressPopupBar > span{
      display:block;
      height:100%;
      background:#000;
    }

    /* Buttons / inputs */
    .btn{
      border:var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadowXs);
      padding:8px 10px;
      text-decoration:none;
      font-size:12px;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      line-height:1;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translate(-1px,-1px); }
    .btn:active{ transform: translate(1px,1px); box-shadow:1px 1px 0 var(--ink); }

    .btnGhost{
      border:var(--borderThin);
      box-shadow:none;
      padding:7px 10px;
    }

    .control{ display:grid; gap:6px; min-width:0; }
    .label{
      font-size:12px;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    .input, .select{
      border:var(--border);
      border-radius:var(--radius);
      padding:10px;
      background:#fff;
      outline:none;
      min-width:0;
    }
    .input:focus, .select:focus{ box-shadow:0 0 0 3px #00000022; }

    /* Year stepper  ◀ Year N ▶ */
    .yearStepper{
      display:flex;
      align-items:stretch;
      border:var(--border);
      box-shadow:var(--shadowXs);
      background:#fff;
    }
    .yearStepper .btn{
      box-shadow:none;
      border:none;
      border-radius:0;
      padding:10px 14px;
      font-size:18px;
      line-height:1;
    }
    .yearStepper .btn:first-child{ border-right:var(--borderThin); }
    .yearStepper .btn:last-child{ border-left:var(--borderThin); }
    .yearNum{
      font-weight:900;
      font-size:13px;
      letter-spacing:0.06em;
      text-transform:uppercase;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      min-width:78px;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:var(--border);
      box-shadow:var(--shadowXs);
      padding:8px 10px;
      background:#fff;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      font-weight:900;
      user-select:none;
    }
    .toggle input{ width:16px; height:16px; accent-color:#000; }

    /* Error */
    .error{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:12px;
      background:#fff;
      margin-bottom:16px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      overflow-wrap:anywhere;
    }

    /* Tabs / nav */
    .navRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tabOn{
      background:#000;
      color:#fff;
    }

    /* Views */
    .view{ display:none; }
    .view.on{ display:block; }

    /* Cards grids: LEFT->RIGHT row-major */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap:16px;
      align-items:start;
      min-width:0;
    }
    @media (max-width:460px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Controls blocks */
    .controls{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:12px;
      background:#fff;
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
      margin-bottom:16px;
      min-width:0;
    }
    @media (max-width:980px){ .controls{ grid-template-columns: 1fr 1fr; } }
    @media (max-width:560px){ .controls{ grid-template-columns: 1fr; } }

    .rowWide{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
    }

    /* Pills */
    .pill{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .tagRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
      min-width:0;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* ===== Library cards ===== */
    .libCard{
      border:var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadow);
      padding:12px;
      min-width:0;
    }
    .libHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-bottom:var(--borderThin);
      padding-bottom:10px;
      margin-bottom:10px;
      min-width:0;
    }
    .libTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:20px;
      letter-spacing:-0.01em;
      margin:0;
      overflow-wrap:anywhere;
    }
    .libAuthor{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      color:var(--muted);
      overflow-wrap:anywhere;
      margin-top:6px;
    }
    /* Library card button drawer – slides out from under card */
    .libDrawer{
      display:grid;
      grid-template-rows:0fr;
      transition:grid-template-rows .25s cubic-bezier(.4,0,1,1);
    }
    .libDrawer > div{ overflow:hidden; }
    .libActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      border-top:var(--borderThin);
      padding:10px 0 4px;
      background:#fafafa;
    }
    /* open: snappier ease-out */
    @media(hover:hover){
      .libCard:hover .libDrawer{
        grid-template-rows:1fr;
        transition:grid-template-rows .3s cubic-bezier(0,0,.2,1);
      }
    }
    .libCard.active .libDrawer{
      grid-template-rows:1fr;
      transition:grid-template-rows .3s cubic-bezier(0,0,.2,1);
    }

    .occList{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
      margin-top:8px;
      margin-bottom:8px;
    }

    /* ===== Plan year cards ===== */
    .yearCard{
      border:var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadow);
      margin:0;
      padding:12px;
      min-width:0;
    }
    .yearHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:var(--borderThin);
      margin-bottom:10px;
      flex-wrap:wrap;
      min-width:0;
    }
    .yearTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:22px;
      letter-spacing:-0.01em;
      margin:0;
      text-transform:uppercase;
    }
    .yearMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      min-width:0;
    }

    .bar{
      height:12px;
      border:var(--borderThin);
      background:#fff;
      position:relative;
      width: 180px;
      max-width: 100%;
      min-width:0;
    }
    .bar > span{
      display:block;
      height:100%;
      background:#000;
      width:0%;
    }

    .readingBlock{
      border:var(--borderThin);
      padding:10px;
      margin-top:10px;
      background:#fff;
      min-width:0;
    }
    .readingHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-bottom:var(--borderThin);
      padding-bottom:8px;
      margin-bottom:8px;
      min-width:0;
    }
    .readingLeft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
      min-width:0;
    }
    .order{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:18px;
      line-height:1;
    }
    .author{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      overflow-wrap:anywhere;
    }
    .tier{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      background:#fff;
      white-space:nowrap;
    }
    .marker{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      background:#fff;
      white-space:nowrap;
    }

    .worksList{ display:grid; gap:8px; min-width:0; }
    .workRow{
      display:grid;
      grid-template-columns: auto 1fr;
      gap:10px;
      align-items:start;
      border:var(--borderThin);
      padding:10px;
      background:#fff;
      min-width:0;
    }
    .workCheck{ display:flex; align-items:center; padding-top:2px; }
    .workCheck input{ width:18px; height:18px; accent-color:#000; }

    .workMain{
      display:grid;
      gap:6px;
      min-width:0;
    }
    .workTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:16px;
      margin:0;
      line-height:1.1;
      overflow-wrap:anywhere;
    }
    .workSub{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      line-height:1.2;
      display:grid;
      gap:4px;
      min-width:0;
      overflow-wrap:anywhere;
    }

    /* Work-row button drawer – slides out from under row */
    .workDrawer{
      grid-column:1/-1;
      display:grid;
      grid-template-rows:0fr;
      transition:grid-template-rows .25s cubic-bezier(.4,0,1,1);
    }
    .workDrawer > div{ overflow:hidden; }
    .workActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      border-top:var(--borderThin);
      padding:8px 0 2px;
      background:#fafafa;
    }
    @media(hover:hover){
      .workRow:hover .workDrawer{
        grid-template-rows:1fr;
        transition:grid-template-rows .3s cubic-bezier(0,0,.2,1);
      }
    }
    .workRow.active .workDrawer{
      grid-template-rows:1fr;
      transition:grid-template-rows .3s cubic-bezier(0,0,.2,1);
    }

    /* Flash highlight */
    .flash{
      outline: 4px solid #000;
      box-shadow: var(--shadowSm);
      animation: flash 1.1s ease;
    }
    @keyframes flash{
      0%{ outline-offset: 0px; }
      60%{ outline-offset: 6px; }
      100%{ outline-offset: 0px; }
    }

    /* ===== Drawer / Popout base ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: #00000055;
      display:none;
      z-index:50;
    }
    .overlay.open{ display:block; }

    .drawer{
      position:fixed;
      top:0;
      height:100%;
      width:min(520px, 92vw);
      max-width:520px;              /* internal max width */
      background:#fff;
      border-left:var(--border);
      box-shadow: -10px 0 0 #000;
      transform: translateX(105%);
      transition: transform 160ms ease;
      z-index:60;
      display:flex;
      flex-direction:column;
      right:0;
      overflow-x:hidden;            /* prevent horizontal scroll */
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding:12px;
      border-bottom:var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .drawerTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:-0.01em;
      font-size:20px;
      margin:0;
    }
    .drawerBody{
      padding:12px;
      overflow:auto;
      overflow-x:hidden;            /* prevent horizontal scroll */
      display:grid;
      gap:12px;
      min-width:0;
    }

    /* Notes */
    .noteTools{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:10px;
      display:grid;
      gap:10px;
      background:#fff;
      min-width:0;
    }
    .noteToolsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-width:0;
    }
    @media (max-width:520px){ .noteToolsRow{ grid-template-columns: 1fr; } }

    .noteList{
      border:var(--border);
      box-shadow:var(--shadowSm);
      background:#fff;
      min-width:0;
    }
    .noteItem{
      border-top:var(--borderThin);
      padding:10px;
      display:grid;
      gap:6px;
      min-width:0;
    }
    .noteItem:first-child{ border-top:none; }
    .noteItemHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
    }
    .noteItemTitle{
      font-weight:900;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin:0;
      overflow-wrap:anywhere;
    }
    .noteItemMeta{
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:0;
    }
    .noteItemPreview{
      color:#111;
      font-size:13px;
      line-height:1.25;
      white-space:pre-wrap;
      max-height: 5.2em;
      overflow:hidden;
      overflow-wrap:anywhere;
      word-break: break-word;
      min-width:0;
    }

    .editor{
      border:var(--border);
      box-shadow:var(--shadowSm);
      background:#fff;
      padding:10px;
      display:grid;
      gap:10px;
      min-width:0;
    }
    .textarea{
      width:100%;
      min-height: 180px;
      border:var(--border);
      border-radius:var(--radius);
      padding:10px;
      outline:none;
      resize: vertical;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.35;
      min-width:0;
      overflow-wrap:anywhere;
      word-break: break-word;
    }
    .textarea:focus{ box-shadow:0 0 0 3px #00000022; }

    .help{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      line-height:1.2;
      overflow-wrap:anywhere;
    }

    /* OpenAlex drawer (left) */
    .oaDrawer{
      left:0;
      right:auto;
      border-left:none;
      border-right:var(--border);
      box-shadow: 10px 0 0 #000;
      transform: translateX(-105%);
    }
    .oaDrawer.open{ transform: translateX(0); }

    .oaPreview{
      border:var(--border);
      box-shadow:var(--shadowSm);
      background:#fff;
      padding:10px;
      display:grid;
      gap:8px;
      word-break: break-word;
      overflow-wrap:anywhere;
      min-width:0;
    }
    .tiny{
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
    }
    .codebox{
      border:var(--borderThin);
      padding:8px;
      background:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      line-height:1.3;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break: break-word;
      min-width:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="masthead">
      <div class="mast-top">
        <div class="brand">The Classics</div>
        <div class="dateline">
          <span id="planName">Library</span>
          <span class="mono">•</span>
          <span id="today">Loading…</span>
        </div>
      </div>

      <div class="rule"></div>

      <div class="subhead">
        <div class="navRow">
          <button class="btn tabOn" id="tabLibrary" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            Library
          </button>
          <button class="btn" id="tabPlan" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Ten-Year Reading Plan
          </button>
          <button class="btn" id="tabBundles" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            Reading Bundles
          </button>
          <button class="btn" id="openOpenAlexBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            OpenAlex Options
          </button>
          <button class="btn" id="openNotesBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
            Notes Drawer
          </button>
        </div>

        <div class="navRow">
          <div class="badge" id="countBadge">0</div>
          <div class="progressBadgeWrap" id="progressBadgeWrap">
            <div class="badge" id="progressBadge">Progress: 0%</div>
            <div class="progressPopup" id="progressPopup" aria-hidden="true">
              <div class="progressPopupTitle">Reading Scores</div>
              <div id="progressPopupContent"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="errorBox" class="error" style="display:none;"></div>

    <!-- ===== LIBRARY VIEW ===== -->
    <section id="libraryView" class="view on" aria-label="All works view">
      <section class="controls" aria-label="library filters">
        <div class="control">
          <div class="label">Search (title/author)</div>
          <input id="libQ" class="input" type="search" placeholder="e.g., Plato, Republic, Aristotle…" autocomplete="off" />
        </div>

        <div class="control">
          <div class="label">Sort</div>
          <select id="libSort" class="select">
            <option value="author">Author A→Z</option>
            <option value="title">Title A→Z</option>
            <option value="occ">Most occurrences</option>
          </select>
        </div>

        <div class="control">
          <div class="label">Tier presence</div>
          <select id="libTierPresence" class="select">
            <option value="all">All</option>
            <option value="core">Has core</option>
            <option value="supplemental">Has supplemental</option>
            <option value="both">Has both</option>
          </select>
        </div>

        <div class="control">
          <div class="label">Show</div>
          <select id="libShow" class="select">
            <option value="all">All</option>
            <option value="incomplete">Only incomplete</option>
            <option value="complete">Only complete</option>
          </select>
        </div>
        <div class="control">
          <div class="label">Add to Bundle</div>
          <select id="libBundleSelect" class="select">
            <option value="">— Select Bundle —</option>
          </select>
        </div>

        <div class="control">
          <div class="label">Bundle Page</div>
          <select id="libBundlePageSelect" class="select">
            <option value="1">Page 1</option>
          </select>
        </div>


        <div class="rowWide">
          <div class="help">Browse all works here. Use “Go to Plan” to jump into the Ten-Year schedule.</div>
          <button class="btn" id="libResetBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
            Reset filters
          </button>
        </div>
      </section>

      <div id="libraryGrid" class="grid" aria-live="polite"></div>
    </section>

    <!-- ===== PLAN VIEW ===== -->
    <section id="planView" class="view" aria-label="Ten-year plan view">
      <section class="controls" aria-label="plan filters">
        <div class="control">
          <div class="label">Search (title/author)</div>
          <input id="q" class="input" type="search" placeholder="e.g., Plato, Republic, Aristotle…" autocomplete="off" />
        </div>

        <div class="control">
          <div class="label">Year</div>
          <div class="yearStepper">
            <button class="btn" id="yearPrev" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <span id="yearDisplay" class="yearNum">Year 1</span>
            <button class="btn" id="yearNext" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
          </div>
        </div>

        <div class="control">
          <div class="label">Tier</div>
          <select id="tierSel" class="select">
            <option value="all">All</option>
            <option value="core">Core</option>
            <option value="supplemental">Supplemental</option>
          </select>
        </div>

        <div class="control">
          <div class="label">Sort</div>
          <select id="sortSel" class="select">
            <option value="plan">Plan order</option>
            <option value="author">Author A→Z</option>
            <option value="title">Title A→Z</option>
          </select>
        </div>

        <div class="rowWide">
          <label class="toggle">
            <input id="onlyIncomplete" type="checkbox" />
            Only incomplete
          </label>

          <button class="btn" id="resetChecksBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
            Reset checks
          </button>
        </div>
      </section>

      <div id="planGrid" class="grid" aria-live="polite"></div>
    </section>

    <!-- ===== BUNDLES VIEW ===== -->
    <section id="bundlesView" class="view" aria-label="Reading Bundles view">
      <section class="controls" aria-label="bundle controls">
        <div class="control">
          <div class="label">Select Bundle</div>
          <select id="bundleSelect" class="select">
            <!-- User bundles only - Ten-Year Plan has its own tab -->
          </select>
        </div>

        <div class="control">
          <div class="label">Page</div>
          <div class="yearStepper">
            <button class="btn" id="bundlePagePrev" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <span id="bundlePageDisplay" class="yearNum">Page 1</span>
            <button class="btn" id="bundlePageNext" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
          </div>
        </div>

        <div class="rowWide">
          <button class="btn" id="newBundleBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Bundle
          </button>
          <button class="btn" id="addBundlePageBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Page
          </button>
          <button class="btn" id="renamePageBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
            Rename Page
          </button>
          <button class="btn" id="renameBundleBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
            Rename Bundle
          </button>
          <button class="btn" id="deleteBundleBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Delete Bundle
          </button>
        </div>
      </section>

      <div id="bundlesGrid" class="grid" aria-live="polite"></div>
    </section>

    <footer style="margin-top:16px; border-top:3px solid #000; padding-top:12px; color:#444; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <div>Data files: <span class="mono">./reading.json</span> (plan), <span class="mono">./project.json</span> (sources)</div>
      <div>Storage: <span class="mono">localStorage</span> (checkboxes + notes + OpenAlex + bundles)</div>
    </footer>
  </div>

  <!-- Shared overlay (used for either drawer) -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Notes Drawer (right) -->
  <aside id="notesDrawer" class="drawer" aria-label="Notes drawer" aria-hidden="true">
    <div class="drawerHeader">
      <h2 class="drawerTitle">Notes</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="newNoteBtn" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          New note
        </button>
        <button class="btn" id="closeNotesBtn" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          Close
        </button>
      </div>
    </div>

    <div class="drawerBody">
      <section class="noteTools">
        <div class="help">Search notes + filter by book tag. Create notes from works or here.</div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Search (title/body)</div>
            <input id="noteSearch" class="input" type="search" placeholder="e.g., justice, virtue, war…" autocomplete="off" />
          </div>

          <div class="control">
            <div class="label">Filter (book tag)</div>
            <select id="noteTagFilter" class="select">
              <option value="all">All</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="exportNotesBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Export JSON
          </button>
          <button class="btn" id="importNotesBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            Import JSON
          </button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </section>

      <section class="noteList" id="noteList" aria-label="notes list"></section>

      <section class="editor" id="noteEditor" style="display:none;" aria-label="note editor">
        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Note title</div>
            <input id="editTitle" class="input" type="text" placeholder="e.g., Republic — justice and the soul" />
          </div>
          <div class="control">
            <div class="label">Book tag</div>
            <select id="editBookTag" class="select"></select>
          </div>
        </div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Year</div>
            <input id="editYear" class="input" type="number" min="1" max="10" placeholder="1" />
          </div>
          <div class="control">
            <div class="label">Author</div>
            <input id="editAuthor" class="input" type="text" placeholder="e.g., Plato" />
          </div>
        </div>

        <div class="control">
          <div class="label">Selections / reference</div>
          <input id="editSelection" class="input" type="text" placeholder="e.g., Book I–II; Ch. 1–5" />
        </div>

        <div class="control">
          <div class="label">Body</div>
          <textarea id="editBody" class="textarea" placeholder="Write your note…"></textarea>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="saveNoteBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            Save
          </button>
          <button class="btn" id="deleteNoteBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Delete
          </button>
          <button class="btn" id="cancelEditBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            Cancel
          </button>
        </div>

        <div class="help" id="editMeta"></div>
      </section>
    </div>
  </aside>

  <!-- OpenAlex Options Popout (left) -->
  <aside id="oaDrawer" class="drawer oaDrawer" aria-label="OpenAlex options" aria-hidden="true">
    <div class="drawerHeader">
      <h2 class="drawerTitle">OpenAlex Options</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="oaResetBtn" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
          Reset
        </button>
        <button class="btn" id="oaCloseBtn" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          Close
        </button>
      </div>
    </div>

    <div class="drawerBody">
      <section class="noteTools">
        <div class="help">These settings apply when you click “OpenAlex” on any work card.</div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Filter target</div>
            <select id="oaTarget" class="select">
              <option value="title_and_abstract.search">Title + Abstract</option>
              <option value="title.search">Title only</option>
            </select>
          </div>

          <div class="control">
            <div class="label">Work type</div>
            <select id="oaType" class="select">
              <option value="all">All</option>
              <option value="journal-article">Journal article</option>
              <option value="book">Book</option>
              <option value="book-chapter">Book chapter</option>
              <option value="proceedings-article">Proceedings article</option>
              <option value="preprint">Preprint</option>
              <option value="dissertation">Dissertation</option>
              <option value="report">Report</option>
              <option value="dataset">Dataset</option>
            </select>
          </div>
        </div>

        <div class="noteToolsRow">
          <label class="toggle" style="justify-content:flex-start;">
            <input id="oaIsOa" type="checkbox" />
            Open access only
          </label>

          <div class="control">
            <div class="label">Language</div>
            <select id="oaLang" class="select">
              <option value="all">Any</option>
              <option value="en">English</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="es">Spanish</option>
              <option value="it">Italian</option>
              <option value="la">Latin</option>
              <option value="grc">Ancient Greek</option>
            </select>
          </div>
        </div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">From year</div>
            <input id="oaFromYear" class="input" type="number" min="1000" max="2100" placeholder="e.g., 1950" />
          </div>
          <div class="control">
            <div class="label">To year</div>
            <input id="oaToYear" class="input" type="number" min="1000" max="2100" placeholder="e.g., 2026" />
          </div>
        </div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Min citations</div>
            <input id="oaMinCites" class="input" type="number" min="0" max="1000000" placeholder="e.g., 10" />
          </div>
          <div class="control">
            <div class="label">Sort</div>
            <select id="oaSort" class="select">
              <option value="relevance">Relevance</option>
              <option value="cited_by_count:desc">Citations ↓</option>
              <option value="publication_date:desc">Newest ↓</option>
              <option value="publication_date:asc">Oldest ↑</option>
            </select>
          </div>
        </div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Per page</div>
            <select id="oaPerPage" class="select">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
          <div class="control">
            <div class="label">Test query</div>
            <input id="oaTestQ" class="input" type="text" placeholder="e.g., Candide" />
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="oaTestBtn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
            Test OpenAlex
          </button>
        </div>
      </section>

      <section class="oaPreview">
        <div class="tiny">Preview URL (using test query)</div>
        <div id="oaPreview" class="codebox"></div>
        <div class="tiny">Format baseline:</div>
        <div class="codebox">https://openalex.org/works?search=Candide&page=1&amp;filter=title_and_abstract.search:Candide</div>
      </section>
    </div>
  </aside>

  <script>
    /* =========================================================
       STORAGE KEYS
       ========================================================= */
    const LS_CHECKS = "greatworks.reading.checks.v2";
    const LS_NOTES  = "greatworks.reading.notes.v1";
    const LS_OA     = "greatworks.openalex.settings.v1";
    const LS_BUNDLES = "greatworks.reading.bundles.v1";
    const LS_ACTIVE_BUNDLE = "greatworks.reading.activebundle.v1";

    /* =========================================================
       HELPERS
       ========================================================= */
    const $ = (sel, root=document) => root.querySelector(sel);

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeText(s){
      return String(s ?? "").toLowerCase().replace(/\s+/g," ").trim();
    }

    function setError(msg){
      const box = $("#errorBox");
      box.style.display = "block";
      box.textContent = msg;
    }
    function clearError(){
      const box = $("#errorBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function uid(){
      return "n_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function nowIso(){
      return new Date().toISOString();
    }

    function safeJsonParse(str, fallback){
      try{ return JSON.parse(str); } catch { return fallback; }
    }

    function isValidUrl(str){
      try{
        const url = new URL(str);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch { return false; }
    }

    function loadChecks(){
      return safeJsonParse(localStorage.getItem(LS_CHECKS) || "{}", {});
    }
    function saveChecks(obj){
      localStorage.setItem(LS_CHECKS, JSON.stringify(obj));
    }

    function loadNotes(){
      return safeJsonParse(localStorage.getItem(LS_NOTES) || "[]", []);
    }
    function saveNotes(arr){
      localStorage.setItem(LS_NOTES, JSON.stringify(arr));
    }

    function defaultOpenAlexSettings(){
      return {
        target: "title_and_abstract.search",
        type: "all",
        is_oa: false,
        lang: "all",
        from_year: "",
        to_year: "",
        min_cites: "",
        sort: "relevance",
        per_page: 25,
        test_q: "Candide"
      };
    }

    function loadOpenAlexSettings(){
      const s = safeJsonParse(localStorage.getItem(LS_OA) || "null", null);
      return { ...defaultOpenAlexSettings(), ...(s || {}) };
    }
    function saveOpenAlexSettings(s){
      localStorage.setItem(LS_OA, JSON.stringify(s));
    }

    // Bundle storage functions
    function loadBundles(){
      return safeJsonParse(localStorage.getItem(LS_BUNDLES) || "[]", []);
    }
    function saveBundles(arr){
      localStorage.setItem(LS_BUNDLES, JSON.stringify(arr));
    }
    function loadActiveBundle(){
      return localStorage.getItem(LS_ACTIVE_BUNDLE) || "__default__";
    }
    function saveActiveBundle(id){
      localStorage.setItem(LS_ACTIVE_BUNDLE, id);
    }
    function bundleUid(){
      // Use crypto.randomUUID if available, fallback to timestamp-based ID
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return "bundle_" + crypto.randomUUID();
      }
      return "bundle_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    // Simple stable hash for DOM ids (no crypto needed)
    function hash32(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0).toString(16);
    }

    function flashEl(el){
      if (!el) return;
      el.classList.remove("flash");
      // force reflow
      void el.offsetWidth;
      el.classList.add("flash");
      setTimeout(()=> el.classList.remove("flash"), 1300);
    }

    function workKey({year, order, tier, author, title, selection, selections}){
      const sel = selection ? `|${selection}` : "";
      const sels = Array.isArray(selections) ? `|${selections.join(" / ")}` : "";
      return `y${year}|o${order}|${tier}|${author}|${title}${sel}${sels}`.toLowerCase();
    }

    /* =========================================================
       OPENALEX URL BUILDER
       ========================================================= */
    function buildOpenAlexUrl({ title, author }){
      const s = state.openalex;
      const q = `${title} ${author}`.trim();
      const page = 1;

      const filterParts = [];
      filterParts.push(`${s.target}:${encodeURIComponent(title)}`);

      if (s.type && s.type !== "all"){
        filterParts.push(`type:${encodeURIComponent(s.type)}`);
      }
      if (s.is_oa){
        filterParts.push(`is_oa:true`);
      }
      if (s.lang && s.lang !== "all"){
        filterParts.push(`language:${encodeURIComponent(s.lang)}`);
      }
      const fromY = String(s.from_year || "").trim();
      const toY = String(s.to_year || "").trim();
      if (fromY){
        filterParts.push(`from_publication_date:${encodeURIComponent(fromY)}-01-01`);
      }
      if (toY){
        filterParts.push(`to_publication_date:${encodeURIComponent(toY)}-12-31`);
      }
      const minC = String(s.min_cites || "").trim();
      if (minC){
        filterParts.push(`cited_by_count:${encodeURIComponent(">" + minC)}`);
      }

      const params = new URLSearchParams();
      params.set("search", q);
      params.set("page", String(page));
      params.set("per_page", String(s.per_page || 25));
      if (s.sort && s.sort !== "relevance"){
        params.set("sort", s.sort);
      }
      if (filterParts.length){
        params.set("filter", filterParts.join(","));
      }

      return `https://openalex.org/works?${params.toString()}`;
    }

    function buildOpenAlexPreviewUrl(){
      const t = String(state.openalex.test_q || "Candide").trim() || "Candide";
      return buildOpenAlexUrl({ title: t, author: "" });
    }

    /* =========================================================
       APP STATE
       ========================================================= */
    const state = {
      plan: null,
      projectBooks: [],  // master list of books from project.json with sourceUrls
      flatWorks: [],     // plan entries (can include duplicates across years)
      libraryWorks: [],  // aggregated unique works for default browsing
      checks: loadChecks(),
      notes: loadNotes(),
      openalex: loadOpenAlexSettings(),
      bundles: loadBundles(),          // user-created bundles
      activeBundleId: loadActiveBundle(), // currently selected bundle id
      defaultBundle: null,             // the default bundle from reading.json
      view: "library",   // "library" | "plan" | "bundles"
      availableYears: [],
      filters: {
        // plan view
        q: "",
        year: "1",
        tier: "all",
        sort: "plan",
        onlyIncomplete: false,
        // library view
        libQ: "",
        libSort: "author",
        libTierPresence: "all",
        libShow: "all",
        // bundle view
        bundleYear: "1"
      },
      ui: {},
      drawer: { open:false, which:null }, // notes | openalex
      notesUI: { search:"", tag:"all", editingId:null },
      tagsUniverse: [] // note tags (titles)
    };

    /* =========================================================
       LOAD PLAN (used for BOTH views)
       ========================================================= */
    async function loadPlan(){
      clearError();
      try{
        // Load project.json first for sourceUrls
        const projectRes = await fetch("./project.json", { cache:"no-store" });
        if (!projectRes.ok) throw new Error(`Could not load project.json (${projectRes.status})`);
        const projectData = await projectRes.json();
        if (!Array.isArray(projectData)) throw new Error("project.json must be an array");
        state.projectBooks = projectData;

        // Load reading.json for the 10-year plan
        const res = await fetch("./reading.json", { cache:"no-store" });
        if (!res.ok) throw new Error(`Could not load reading.json (${res.status})`);
        const data = await res.json();
        if (!data || !Array.isArray(data.years)) throw new Error("reading.json must include { plan_name, years: [...] }");

        state.plan = data;

        // Store as the default bundle (read-only, from reading.json)
        state.defaultBundle = {
          id: "__default__",
          plan_name: data.plan_name || "Ten-Year Reading Plan",
          years: typeof structuredClone === 'function' ? structuredClone(data.years) : JSON.parse(JSON.stringify(data.years)),
          isDefault: true
        };

        const today = new Date().toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
        $("#today").textContent = today;

        flattenPlan();
        buildLibraryWorks();
        fillYearOptions();
        buildTagsUniverse();
        buildBundleDropdowns();

        syncOpenAlexUIFromState();
        updateOpenAlexPreview();

        wireUI();
        renderAll();
      } catch(err){
        setError(`LOAD ERROR: ${err.message}`);
      }
    }

    /* =========================================================
       SOURCE URL LOOKUP
       ========================================================= */
    function getSourceUrlFromProject(author, title){
      // Look up sourceUrl from project.json by matching author and title
      const normalizeStr = (s) => (s || "").toLowerCase().trim();
      const authorNorm = normalizeStr(author);
      const titleNorm = normalizeStr(title);
      
      for (const book of state.projectBooks){
        const bookAuthor = normalizeStr(book.author);
        const bookTitle = normalizeStr(book.title);
        
        // Match both author and title
        if (bookAuthor === authorNorm && bookTitle === titleNorm){
          return book.src || "";
        }
      }
      return "";
    }

    function flattenPlan(){
      const flat = [];
      const years = state.plan.years || [];
      for (const y of years){
        const yearNum = Number(y.year);
        const readings = y.readings || [];
        for (const r of readings){
          const order = Number(r.order);
          const tier = String(r.tier || "").toLowerCase();
          const marker = r.marker ?? "";
          const author = String(r.author || "").trim();

          const works = Array.isArray(r.works) ? r.works : [];
          for (const w of works){
            const title = String(w.title || "").trim();
            const selection = w.selection ? String(w.selection).trim() : "";
            const selections = Array.isArray(w.selections) ? w.selections.map(s=>String(s).trim()).filter(Boolean) : null;
            
            // Look up sourceUrl from project.json instead of reading.json
            const sourceUrl = getSourceUrlFromProject(author, title);

            const key = workKey({year:yearNum, order, tier, author, title, selection, selections});
            const search = normalizeText(`${author} ${title} ${selection} ${(selections||[]).join(" ")}`);

            flat.push({
              year: yearNum,
              order,
              tier,
              marker,
              author,
              work: { title, selection, selections },
              key,
              search,
              sourceUrl
            });
          }
        }
      }
      state.flatWorks = flat;
    }

    function buildLibraryWorks(){
      // Aggregate by Author + Title (unique library cards)
      const map = new Map();

      for (const fw of state.flatWorks){
        const author = fw.author || "Unknown";
        const title = fw.work.title || "Untitled";
        const libKey = `${author}||${title}`.toLowerCase();
        if (!map.has(libKey)){
          map.set(libKey, {
            libKey,
            id: `lib_${hash32(libKey)}`,
            author,
            title,
            hasCore:false,
            hasSupplemental:false,
            occurrences: [], // { year, order, tier, marker, key, selection, selections }
            search: normalizeText(`${author} ${title}`),
            sourceUrl: ""
          });
        }
        const item = map.get(libKey);
        if (fw.tier === "core") item.hasCore = true;
        if (fw.tier === "supplemental") item.hasSupplemental = true;
        // Pick up sourceUrl from any occurrence (prefer first non-empty)
        if (!item.sourceUrl && fw.sourceUrl) item.sourceUrl = fw.sourceUrl;

        item.occurrences.push({
          year: fw.year,
          order: fw.order,
          tier: fw.tier,
          marker: fw.marker,
          key: fw.key,
          selection: fw.work.selection || "",
          selections: fw.work.selections || null
        });
      }

      const arr = Array.from(map.values());
      for (const it of arr){
        it.occurrences.sort((a,b)=> a.year-b.year || a.order-b.order);
      }
      state.libraryWorks = arr;
    }

    function fillYearOptions(){
      state.availableYears = (state.plan.years || []).map(y=>Number(y.year)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
      if (state.availableYears.length){
        state.filters.year = String(state.availableYears[0]);
      }
      updateYearStepper();
    }

    function updateYearStepper(){
      $("#yearDisplay").textContent = `Year ${state.filters.year}`;
    }

    function buildTagsUniverse(){
      // Keep notes "as they are": book_tag = title
      const set = new Set();
      for (const fw of state.flatWorks){
        if (fw.work.title) set.add(fw.work.title);
      }
      state.tagsUniverse = Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));

      $("#noteTagFilter").innerHTML =
        `<option value="all">All</option>` +
        state.tagsUniverse.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      $("#editBookTag").innerHTML =
        state.tagsUniverse.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    }

    /* =========================================================
       BUNDLE MANAGEMENT
       ========================================================= */
    function getAllBundles(){
      // Returns array of all bundles (default + user-created)
      const bundles = [];
      if (state.defaultBundle){
        bundles.push(state.defaultBundle);
      }
      for (const b of state.bundles){
        bundles.push(b);
      }
      return bundles;
    }

    function getBundleById(id){
      if (id === "__default__") return state.defaultBundle;
      return state.bundles.find(b => b.id === id) || null;
    }

    function getActiveBundle(){
      // Return the active bundle for bundle view, excluding the default bundle
      const bundle = getBundleById(state.activeBundleId);
      // If the selected bundle is the default, return null for bundle view
      if (bundle && bundle.isDefault) return null;
      return bundle;
    }

    function buildBundleDropdowns(){
      // User bundles only (exclude default Ten-Year Reading Plan from bundle view)
      const userBundles = state.bundles || [];
      
      // Bundle view dropdown (user bundles only - Ten-Year Plan has its own tab)
      const bundleSelect = $("#bundleSelect");
      const bundleOptions = userBundles.map(b => 
        `<option value="${escapeHtml(b.id)}">${escapeHtml(b.plan_name)}</option>`
      );
      if (bundleOptions.length === 0) {
        bundleOptions.push(`<option value="">— No Bundles Yet —</option>`);
      }
      bundleSelect.innerHTML = bundleOptions.join("");
      // Set to first user bundle if current selection was default
      if (state.activeBundleId === "__default__" && userBundles.length > 0) {
        state.activeBundleId = userBundles[0].id;
        saveActiveBundle(state.activeBundleId);
      }
      bundleSelect.value = state.activeBundleId;

      // Library page bundle dropdown (user bundles only, not default)
      const libBundleSelect = $("#libBundleSelect");
      libBundleSelect.innerHTML = 
        `<option value="">— Select Bundle —</option>` +
        userBundles.map(b => 
          `<option value="${escapeHtml(b.id)}">${escapeHtml(b.plan_name)}</option>`
        ).join("");

      updateBundlePageDropdown();
      updateLibBundlePageDropdown();
    }

    function updateBundlePageDropdown(){
      const bundle = getActiveBundle();
      if (!bundle) return;
      
      const years = bundle.years || [];
      const bundlePageDisplay = $("#bundlePageDisplay");
      
      if (years.length === 0){
        state.filters.bundleYear = "1";
        bundlePageDisplay.textContent = "Page 1";
      } else {
        const availablePages = years.map(y => Number(y.year)).filter(n => Number.isFinite(n)).sort((a,b) => a - b);
        if (!availablePages.includes(Number(state.filters.bundleYear))){
          state.filters.bundleYear = availablePages.length > 0 ? String(availablePages[0]) : "1";
        }
        // Show custom page name if available
        const currentPage = Number(state.filters.bundleYear);
        const yearObj = years.find(y => Number(y.year) === currentPage);
        const pageName = yearObj?.name || `Page ${state.filters.bundleYear}`;
        bundlePageDisplay.textContent = pageName;
      }
    }

    function updateLibBundlePageDropdown(){
      const libBundleSelect = $("#libBundleSelect");
      const libBundlePageSelect = $("#libBundlePageSelect");
      const selectedBundleId = libBundleSelect.value;

      if (!selectedBundleId){
        libBundlePageSelect.innerHTML = `<option value="1">Page 1</option>`;
        return;
      }

      const bundle = getBundleById(selectedBundleId);
      if (!bundle || !bundle.years || bundle.years.length === 0){
        libBundlePageSelect.innerHTML = `<option value="1">Page 1</option>`;
        return;
      }

      const pages = bundle.years.map(y => Number(y.year)).filter(n => Number.isFinite(n)).sort((a,b) => a - b);
      libBundlePageSelect.innerHTML = pages.map(p => 
        `<option value="${p}">Page ${p}</option>`
      ).join("");
    }

    function createNewBundle(name){
      const bundle = {
        id: bundleUid(),
        plan_name: name || "New Bundle",
        years: [{ year: 1, readings: [] }],
        isDefault: false
      };
      state.bundles.push(bundle);
      saveBundles(state.bundles);
      state.activeBundleId = bundle.id;
      saveActiveBundle(state.activeBundleId);
      buildBundleDropdowns();
      return bundle;
    }

    function addPageToBundle(bundleId){
      const bundle = getBundleById(bundleId);
      if (!bundle || bundle.isDefault) return;

      const years = bundle.years || [];
      const maxYear = years.reduce((m, y) => Math.max(m, Number(y.year) || 0), 0);
      const newYear = maxYear + 1;
      
      bundle.years.push({ year: newYear, readings: [] });
      saveBundles(state.bundles);
      state.filters.bundleYear = String(newYear);
      updateBundlePageDropdown();
      renderBundles();
    }

    function deleteBundle(bundleId){
      if (bundleId === "__default__") return; // Cannot delete default
      
      const idx = state.bundles.findIndex(b => b.id === bundleId);
      if (idx >= 0){
        state.bundles.splice(idx, 1);
        saveBundles(state.bundles);
        state.activeBundleId = "__default__";
        saveActiveBundle(state.activeBundleId);
        buildBundleDropdowns();
        renderBundles();
      }
    }

    function renameBundle(bundleId, newName){
      const bundle = getBundleById(bundleId);
      if (!bundle || bundle.isDefault) return;
      
      bundle.plan_name = newName;
      saveBundles(state.bundles);
      buildBundleDropdowns();
    }

    function renameBundlePage(bundleId, pageNum, newName){
      const bundle = getBundleById(bundleId);
      if (!bundle || bundle.isDefault) return;
      
      const yearObj = bundle.years?.find(y => Number(y.year) === pageNum);
      if (yearObj){
        yearObj.name = newName;
        saveBundles(state.bundles);
        // Update the page display
        $("#bundlePageDisplay").textContent = newName;
        renderBundles();
      }
    }

    function addBookToBundle(bundleId, pageNum, bookData){
      const bundle = getBundleById(bundleId);
      if (!bundle || bundle.isDefault) return false;

      let yearObj = bundle.years.find(y => Number(y.year) === pageNum);
      if (!yearObj){
        yearObj = { year: pageNum, readings: [] };
        bundle.years.push(yearObj);
        bundle.years.sort((a,b) => Number(a.year) - Number(b.year));
      }

      // Find next order number
      const maxOrder = yearObj.readings.reduce((m, r) => Math.max(m, Number(r.order) || 0), 0);
      
      yearObj.readings.push({
        order: maxOrder + 1,
        tier: "core",
        author: bookData.author || "Unknown",
        works: [{
          title: bookData.title || "Untitled",
          sourceUrl: bookData.sourceUrl || ""
        }]
      });

      saveBundles(state.bundles);
      return true;
    }

    function removeReadingFromBundle(bundleId, pageNum, order){
      const bundle = getBundleById(bundleId);
      if (!bundle || bundle.isDefault) return;

      const yearObj = bundle.years.find(y => Number(y.year) === pageNum);
      if (!yearObj) return;

      const idx = yearObj.readings.findIndex(r => Number(r.order) === order);
      if (idx >= 0){
        yearObj.readings.splice(idx, 1);
        // Re-order remaining readings
        yearObj.readings.forEach((r, i) => r.order = i + 1);
        saveBundles(state.bundles);
        renderBundles();
      }
    }

    /* =========================================================
       VIEW SWITCHING
       ========================================================= */
    function setView(view){
      state.view = view;

      $("#libraryView").classList.toggle("on", view === "library");
      $("#planView").classList.toggle("on", view === "plan");
      $("#bundlesView").classList.toggle("on", view === "bundles");

      $("#tabLibrary").classList.toggle("tabOn", view === "library");
      $("#tabPlan").classList.toggle("tabOn", view === "plan");
      $("#tabBundles").classList.toggle("tabOn", view === "bundles");

      if (view === "library"){
        $("#planName").textContent = "Library";
      } else if (view === "plan"){
        $("#planName").textContent = state.plan?.plan_name || "Ten-Year Plan";
      } else if (view === "bundles"){
        const bundle = getActiveBundle();
        $("#planName").textContent = bundle?.plan_name || "Reading Bundles";
      }

      renderAll();
    }

    /* =========================================================
       PROGRESS
       ========================================================= */
    function computeProgress(){
      const total = state.flatWorks.length;
      let done = 0;
      for (const w of state.flatWorks){
        if (state.checks[w.key]) done++;
      }
      const pct = total ? Math.round((done/total)*100) : 0;
      return { total, done, pct };
    }

    function computeBundleProgress(bundle){
      let total = 0;
      let done = 0;
      for (const year of (bundle.years || [])){
        for (const reading of (year.readings || [])){
          for (const work of (reading.works || [])){
            total++;
            const bundleWorkKey = `bundle:${bundle.id}:${year.year}:${reading.order || 1}:${work.title || "Untitled"}`;
            if (state.checks[bundleWorkKey]) done++;
          }
        }
      }
      const pct = total ? Math.round((done/total)*100) : 0;
      return { total, done, pct };
    }

    function updateProgressBadge(){
      const { total, done, pct } = computeProgress();
      $("#progressBadge").textContent = `Progress: ${pct}%`;
      $("#countBadge").textContent = `${done}/${total} done`;
      
      // Update popup content
      updateProgressPopup();
    }

    function updateProgressPopup(){
      const popupContent = $("#progressPopupContent");
      let html = '';
      
      // Ten-Year Reading Plan progress
      const tenYearProgress = computeProgress();
      html += `
        <div class="progressPopupRow">
          <span class="progressPopupName">Ten-Year Reading Plan</span>
          <span class="progressPopupScore">${tenYearProgress.done}/${tenYearProgress.total}</span>
          <span class="progressPopupBar"><span style="width:${tenYearProgress.pct}%"></span></span>
        </div>
      `;
      
      // User bundles progress
      const userBundles = state.bundles || [];
      for (const bundle of userBundles){
        const bp = computeBundleProgress(bundle);
        html += `
          <div class="progressPopupRow">
            <span class="progressPopupName">${escapeHtml(bundle.plan_name)}</span>
            <span class="progressPopupScore">${bp.done}/${bp.total}</span>
            <span class="progressPopupBar"><span style="width:${bp.pct}%"></span></span>
          </div>
        `;
      }
      
      if (userBundles.length === 0){
        html += `<div style="font-size:11px; color:var(--muted); padding:6px 0;">No user bundles yet.</div>`;
      }
      
      popupContent.innerHTML = html;
    }

    /* =========================================================
       FILTERING
       ========================================================= */
    function filteredLibrary(){
      const q = normalizeText(state.filters.libQ);
      const tierPresence = state.filters.libTierPresence;
      const show = state.filters.libShow;

      let items = state.libraryWorks.slice();

      if (q){
        items = items.filter(it => normalizeText(`${it.author} ${it.title}`).includes(q));
      }

      if (tierPresence !== "all"){
        const hasC = it => it.hasCore;
        const hasS = it => it.hasSupplemental;
        items = items.filter(it => {
          if (tierPresence === "core") return hasC(it);
          if (tierPresence === "supplemental") return hasS(it);
          if (tierPresence === "both") return hasC(it) && hasS(it);
          return true;
        });
      }

      if (show !== "all"){
        items = items.filter(it => {
          const occ = it.occurrences;
          const doneCount = occ.reduce((a,o)=> a + (state.checks[o.key] ? 1 : 0), 0);
          const allDone = doneCount === occ.length;
          if (show === "complete") return allDone;
          if (show === "incomplete") return !allDone;
          return true;
        });
      }

      const sort = state.filters.libSort;
      if (sort === "author"){
        items.sort((a,b)=> a.author.localeCompare(b.author, undefined, { sensitivity:"base" }) || a.title.localeCompare(b.title, undefined, { sensitivity:"base" }));
      } else if (sort === "title"){
        items.sort((a,b)=> a.title.localeCompare(b.title, undefined, { sensitivity:"base" }) || a.author.localeCompare(b.author, undefined, { sensitivity:"base" }));
      } else if (sort === "occ"){
        items.sort((a,b)=> b.occurrences.length - a.occurrences.length || a.author.localeCompare(b.author) || a.title.localeCompare(b.title));
      }

      return items;
    }

    function applyPlanFilters(){
      const f = state.filters;
      const q = normalizeText(f.q);

      let items = state.flatWorks.slice();

      if (f.year !== "all"){
        const y = Number(f.year);
        items = items.filter(x => x.year === y);
      }
      if (f.tier !== "all"){
        items = items.filter(x => x.tier === f.tier);
      }
      if (q){
        items = items.filter(x => x.search.includes(q));
      }
      if (f.onlyIncomplete){
        items = items.filter(x => !state.checks[x.key]);
      }

      if (f.sort === "plan"){
        items.sort((a,b)=> a.year-b.year || a.order-b.order || a.work.title.localeCompare(b.work.title));
      } else if (f.sort === "author"){
        items.sort((a,b)=> a.author.localeCompare(b.author, undefined, { sensitivity:"base" })
          || a.year-b.year || a.order-b.order || a.work.title.localeCompare(b.work.title));
      } else if (f.sort === "title"){
        items.sort((a,b)=> a.work.title.localeCompare(b.work.title, undefined, { sensitivity:"base" })
          || a.year-b.year || a.order-b.order);
      }

      return items;
    }

    function groupByYear(filtered){
      const map = new Map();
      for (const item of filtered){
        if (!map.has(item.year)) map.set(item.year, []);
        map.get(item.year).push(item);
      }
      const years = Array.from(map.keys()).sort((a,b)=>a-b);
      return years.map(y => ({ year:y, items: map.get(y) }));
    }

    /* =========================================================
       RENDER
       ========================================================= */
    function renderAll(){
      updateProgressBadge();

      if (state.view === "library") renderLibrary();
      else if (state.view === "plan") renderPlan();
      else if (state.view === "bundles") renderBundles();

      // Keep OpenAlex preview live
      updateOpenAlexPreview();

      // Notes list refresh if open
      if (state.drawer.open && state.drawer.which === "notes"){
        renderNotesList();
      }
    }

    function renderLibrary(){
      const grid = $("#libraryGrid");
      const items = filteredLibrary();

      if (!items.length){
        grid.innerHTML = `
          <section class="libCard">
            <div class="libHead">
              <div>
                <p class="libTitle">No matches</p>
                <div class="libAuthor">Try different filters</div>
              </div>
            </div>
            <div class="help">Nothing matched your library filters.</div>
          </section>
        `;
        return;
      }

      grid.innerHTML = items.map(libCardHtml).join("");
      wireLibraryDelegation();
    }

    function libCardHtml(it){
      const occ = it.occurrences;
      const doneCount = occ.reduce((a,o)=> a + (state.checks[o.key] ? 1 : 0), 0);
      const allDone = doneCount === occ.length;

      const tierPills = [
        it.hasCore ? `<span class="pill">Has core</span>` : "",
        it.hasSupplemental ? `<span class="pill">Has supplemental</span>` : ""
      ].filter(Boolean).join("");

      const notesCount = state.notes.filter(n => n.book_tag === it.title).length;

      // Per-occurrence pills (click to jump to that exact place in the plan)
      const occPills = occ.slice(0, 10).map(o => {
        const label = `Y${o.year} #${o.order}${o.marker ? " " + o.marker : ""}`;
        return `<button class="btn btnGhost" type="button"
                  data-action="gotoPlanOcc"
                  data-workkey="${escapeHtml(o.key)}"
                  title="Jump to Year ${escapeHtml(o.year)}"
                >${escapeHtml(label)}</button>`;
      }).join("");

      const more = occ.length > 10 ? `<span class="pill">+${escapeHtml(occ.length - 10)} more</span>` : "";

      const firstKey = occ[0]?.key || "";

      return `
        <section class="libCard" id="${escapeHtml(it.id)}" data-libkey="${escapeHtml(it.libKey)}" data-author="${escapeHtml(it.author)}" data-title="${escapeHtml(it.title)}"${it.sourceUrl ? ` data-sourceurl="${escapeHtml(it.sourceUrl)}"` : ""}>
          <div class="libHead">
            <div style="min-width:0;">
              <p class="libTitle">${escapeHtml(it.title)}</p>
              <div class="libAuthor">${escapeHtml(it.author)}</div>
              <div class="tagRow">
                <span class="pill">${escapeHtml(doneCount)}/${escapeHtml(occ.length)} done</span>
                <span class="pill">${allDone ? "Complete" : "Incomplete"}</span>
                <span class="pill">Notes ${escapeHtml(notesCount)}</span>
                ${tierPills}
              </div>
            </div>

          </div>

          <div class="help">Plan occurrences (click a pill to jump):</div>
          <div class="occList">
            ${occPills}
            ${more}
          </div>

          <div class="libDrawer"><div>
            <div class="libActions">
              <button class="btn" type="button" data-action="openOpenAlexLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                OpenAlex
              </button>
              <button class="btn" type="button" data-action="openWikipediaLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path><path d="M2 12h20"></path></svg>
                Wikipedia
              </button>
              <button class="btn" type="button" data-action="openWikiSearchLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                WikiSearch
              </button>
              ${it.sourceUrl ? `<button class="btn" type="button" data-action="openSourceLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                Source
              </button>` : ""}
              <button class="btn" type="button" data-action="newNoteLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                New note
              </button>
              <button class="btn" type="button" data-action="openNotesLib">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                Open notes
              </button>
              <button class="btn" type="button" data-action="gotoPlanFirst" data-workkey="${escapeHtml(firstKey)}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                Go to plan
              </button>
              <button class="btn" type="button" data-action="addToBundle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                Add to Bundle
              </button>
            </div>
          </div></div>
        </section>
      `;
    }

    function renderPlan(){
      const grid = $("#planGrid");
      const filtered = applyPlanFilters();
      const grouped = groupByYear(filtered);

      if (!grouped.length){
        grid.innerHTML = `
          <div class="yearCard">
            <div class="yearHeader">
              <h2 class="yearTitle">No matches</h2>
              <div class="yearMeta"><span>Try different filters</span></div>
            </div>
            <div class="help">Nothing matched your plan search/tier/year/incomplete filter.</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = grouped.map(g => yearCardHtml(g.year, g.items)).join("");
      wirePlanDelegation();
    }

    function renderBundles(){
      const grid = $("#bundlesGrid");
      const bundle = getActiveBundle();

      if (!bundle){
        grid.innerHTML = `
          <div class="yearCard">
            <div class="yearHeader">
              <h2 class="yearTitle">No bundle selected</h2>
              <div class="yearMeta"><span>Create a new bundle to get started</span></div>
            </div>
          </div>
        `;
        return;
      }

      // Update the header with bundle name
      $("#planName").textContent = bundle.plan_name;

      const years = bundle.years || [];
      const currentPage = Number(state.filters.bundleYear) || 1;
      const yearData = years.find(y => Number(y.year) === currentPage);

      if (!yearData){
        grid.innerHTML = `
          <div class="yearCard">
            <div class="yearHeader">
              <h2 class="yearTitle">Page ${currentPage}</h2>
              <div class="yearMeta"><span>No readings yet</span></div>
            </div>
            <div class="help">${bundle.isDefault ? 'This is a read-only bundle from reading.json.' : 'Add books from the Library to this bundle page.'}</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = bundlePageCardHtml(bundle, yearData);
      wireBundlesDelegation();
    }

    function bundlePageCardHtml(bundle, yearData){
      const pageNum = Number(yearData.year);
      const pageName = yearData.name || `Page ${pageNum}`;
      const readings = yearData.readings || [];
      const total = readings.reduce((acc, r) => acc + (r.works?.length || 0), 0);
      
      // Count completed works in this bundle page
      let done = 0;
      for (const r of readings) {
        for (const w of (r.works || [])) {
          const bundleWorkKey = `bundle:${bundle.id}:${pageNum}:${r.order || 1}:${w.title || "Untitled"}`;
          if (state.checks[bundleWorkKey]) done++;
        }
      }
      const pct = total ? Math.round((done/total)*100) : 0;
      const barW = pct;

      const readingsHtml = readings.map(r => bundleReadingBlockHtml(bundle, pageNum, r)).join("");

      return `
        <section class="yearCard" data-year="${pageNum}" data-bundleid="${escapeHtml(bundle.id)}">
          <div class="yearHeader">
            <h2 class="yearTitle">${escapeHtml(pageName)}</h2>
            <div class="yearMeta">
              <span>${escapeHtml(done)}/${escapeHtml(total)} done</span>
              <span class="mono">•</span>
              <span class="bar" aria-label="progress bar"><span style="width:${barW}%"></span></span>
              ${bundle.isDefault ? '<span class="pill">Read-only</span>' : ''}
            </div>
          </div>
          ${readingsHtml || '<div class="help">No readings on this page yet.</div>'}
        </section>
      `;
    }

    function bundleReadingBlockHtml(bundle, pageNum, reading){
      const order = reading.order || 1;
      const tier = reading.tier || "core";
      const author = reading.author || "Unknown";
      const works = reading.works || [];

      const worksHtml = works.map(w => bundleWorkRowHtml(bundle, pageNum, order, w, author)).join("");

      return `
        <div class="readingBlock" data-year="${pageNum}" data-order="${order}" data-bundleid="${escapeHtml(bundle.id)}">
          <div class="readingHead">
            <div class="readingLeft">
              <div class="order">#${escapeHtml(order)}</div>
              <div class="author">${escapeHtml(author)}</div>
              <span class="tier">${escapeHtml(tier)}</span>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" type="button" data-action="markBundleBlockDone">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Mark block done
              </button>
              <button class="btn" type="button" data-action="markBundleBlockUndone">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle></svg>
                Mark block undone
              </button>
              ${!bundle.isDefault ? `
                <button class="btn" type="button" data-action="removeReading" data-bundleid="${escapeHtml(bundle.id)}" data-page="${pageNum}" data-order="${order}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  Remove
                </button>
              ` : ''}
            </div>
          </div>
          <div class="worksList">
            ${worksHtml}
          </div>
        </div>
      `;
    }

    function bundleWorkRowHtml(bundle, pageNum, order, work, author){
      const title = work.title || "Untitled";
      const sourceUrl = work.sourceUrl || "";
      const selection = work.selection || "";
      const sel = selection ? `Selection: ${selection}` : "";
      const sels = Array.isArray(work.selections) && work.selections.length ? `Selections: ${work.selections.join("; ")}` : "";
      const subLines = [sel, sels].filter(Boolean);

      // Generate workKey for checkbox state (similar to plan view)
      const bundleWorkKey = `bundle:${bundle.id}:${pageNum}:${order}:${title}`;
      const checked = !!state.checks[bundleWorkKey];
      
      // Count notes for this book
      const noteCount = state.notes.filter(n => n.book_tag === title).length;

      return `
        <div class="workRow"
             data-workkey="${escapeHtml(bundleWorkKey)}"
             data-book="${escapeHtml(title)}"
             data-author="${escapeHtml(author)}"
             data-year="${escapeHtml(pageNum)}"
             data-order="${escapeHtml(order)}"
             data-selection="${escapeHtml(selection)}"
             ${sourceUrl ? `data-sourceurl="${escapeHtml(sourceUrl)}"` : ""}
        >
          <div class="workCheck">
            <input type="checkbox" ${checked ? "checked" : ""} aria-label="complete checkbox" data-action="toggleBundleComplete" />
          </div>

          <div class="workMain">
            <p class="workTitle">${escapeHtml(title)}</p>
            <div class="workSub">
              <div class="tagRow">
                <span class="pill">Page ${escapeHtml(pageNum)}</span>
                <span class="pill">Order ${escapeHtml(order)}</span>
                <span class="pill">Notes ${escapeHtml(noteCount)}</span>
              </div>
              ${subLines.length ? `<div>${subLines.map(escapeHtml).join("<br>")}</div>` : ""}
            </div>
          </div>

          <div class="workDrawer"><div>
            <div class="workActions">
              <button class="btn" type="button" data-action="openOpenAlex">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                OpenAlex
              </button>
              <button class="btn" type="button" data-action="openWikipedia">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path><path d="M2 12h20"></path></svg>
                Wikipedia
              </button>
              <button class="btn" type="button" data-action="openWikiSearch">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                WikiSearch
              </button>
              ${sourceUrl ? `<button class="btn" type="button" data-action="openSource">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                Source
              </button>` : ""}
              <button class="btn" type="button" data-action="openLibraryForWork">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                View in library
              </button>
              <button class="btn" type="button" data-action="newNoteFromWork">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                New note
              </button>
              <button class="btn" type="button" data-action="openNotesForBook">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                Open notes
              </button>
            </div>
          </div></div>
        </div>
      `;
    }

    function wireBundlesDelegation(){
      const grid = $("#bundlesGrid");

      grid.onclick = (e) => {
        // Mobile: tap anywhere on work row (outside buttons/checkboxes) toggles work row expansion
        if (!window.matchMedia("(hover:hover)").matches) {
          if (!e.target.closest("[data-action]") && !e.target.closest("input")) {
            const row = e.target.closest(".workRow");
            if (row) {
              const was = row.classList.contains("active");
              grid.querySelectorAll(".workRow.active").forEach(r => r.classList.remove("active"));
              if (!was) row.classList.add("active");
              return;
            }
          }
        }

        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "removeReading"){
          const bundleId = btn.dataset.bundleid;
          const page = Number(btn.dataset.page);
          const order = Number(btn.dataset.order);
          if (confirm("Remove this reading from the bundle?")){
            removeReadingFromBundle(bundleId, page, order);
          }
          return;
        }

        // Mark bundle block done/undone
        if (action === "markBundleBlockDone" || action === "markBundleBlockUndone"){
          const block = btn.closest(".readingBlock");
          if (!block) return;
          const bundleId = block.dataset.bundleid;
          const pageNum = Number(block.dataset.year);
          const order = Number(block.dataset.order);
          const workRows = block.querySelectorAll(".workRow[data-workkey]");
          for (const r of workRows) {
            const key = r.dataset.workkey;
            state.checks[key] = (action === "markBundleBlockDone");
          }
          saveChecks(state.checks);
          renderBundles();
          return;
        }

        const row = btn.closest(".workRow");
        if (!row) return;

        if (action === "openOpenAlex"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          window.open(buildOpenAlexUrl({ title, author }), "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openWikipedia"){
          const title = row.dataset.book || "";
          const wikiTitle = encodeURIComponent(title.replace(/\s+/g, "_"));
          window.open(`https://en.wikipedia.org/wiki/${wikiTitle}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openWikiSearch"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          const q = encodeURIComponent(`${title} ${author}`.trim());
          window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${q}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openSource"){
          const sourceUrl = row.dataset.sourceurl;
          if (sourceUrl) window.open(sourceUrl, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openLibraryForWork"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          gotoLibraryWork(author, title);
          return;
        }

        if (action === "newNoteFromWork" || action === "openNotesForBook"){
          const ctx = {
            book_tag: row.dataset.book || "",
            author: row.dataset.author || "",
            year: row.dataset.year || "",
            order: row.dataset.order || "",
            selection: row.dataset.selection || ""
          };

          if (action === "newNoteFromWork"){
            openDrawer("notes");
            startNewNote(ctx);
          } else {
            openDrawer("notes");
            state.notesUI.tag = ctx.book_tag;
            $("#noteTagFilter").value = ctx.book_tag;
            renderNotesList();
          }
          return;
        }
      };

      grid.onchange = (e) => {
        const cb = e.target.closest('input[type="checkbox"][data-action="toggleBundleComplete"]');
        if (!cb) return;
        const row = cb.closest(".workRow");
        const key = row.dataset.workkey;
        state.checks[key] = cb.checked;
        saveChecks(state.checks);
        renderBundles();
      };
    }

    function yearCardHtml(year, items){
      const total = items.length;
      const done = items.reduce((acc,x)=> acc + (state.checks[x.key] ? 1 : 0), 0);
      const pct = total ? Math.round((done/total)*100) : 0;
      const barW = pct;

      const blocks = new Map();
      for (const it of items){
        const blockKey = `${it.order}|${it.tier}|${it.marker||""}|${it.author}`;
        if (!blocks.has(blockKey)) blocks.set(blockKey, { order: it.order, tier: it.tier, marker: it.marker, author: it.author, works: [] });
        blocks.get(blockKey).works.push(it);
      }
      const blockArr = Array.from(blocks.values()).sort((a,b)=>a.order-b.order);

      return `
        <section class="yearCard" data-year="${year}">
          <div class="yearHeader">
            <h2 class="yearTitle">Year ${escapeHtml(year)}</h2>
            <div class="yearMeta">
              <span>${escapeHtml(done)}/${escapeHtml(total)} done</span>
              <span class="mono">•</span>
              <span class="bar" aria-label="progress bar"><span style="width:${barW}%"></span></span>
            </div>
          </div>
          ${blockArr.map(b => readingBlockHtml(year, b)).join("")}
        </section>
      `;
    }

    function readingBlockHtml(year, block){
      const tierLabel = block.tier || "—";
      const marker = block.marker ? `<span class="marker">${escapeHtml(block.marker)}</span>` : "";
      const worksHtml = block.works.map(w => workRowHtml(w)).join("");

      return `
        <div class="readingBlock" data-year="${year}" data-order="${block.order}">
          <div class="readingHead">
            <div class="readingLeft">
              <div class="order">#${escapeHtml(block.order)}</div>
              <div class="author">${escapeHtml(block.author || "Unknown")}</div>
              <span class="tier">${escapeHtml(tierLabel)}</span>
              ${marker}
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" type="button" data-action="markBlockDone">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Mark block done
              </button>
              <button class="btn" type="button" data-action="markBlockUndone">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle></svg>
                Mark block undone
              </button>
            </div>
          </div>
          <div class="worksList">
            ${worksHtml}
          </div>
        </div>
      `;
    }

    function workRowHtml(w){
      const checked = !!state.checks[w.key];
      const title = w.work.title || "Untitled";
      const sel = w.work.selection ? `Selection: ${w.work.selection}` : "";
      const sels = Array.isArray(w.work.selections) && w.work.selections.length ? `Selections: ${w.work.selections.join("; ")}` : "";
      const subLines = [sel, sels].filter(Boolean);

      const noteCount = state.notes.filter(n => n.book_tag === title).length;

      return `
        <div class="workRow"
             data-workkey="${escapeHtml(w.key)}"
             data-book="${escapeHtml(title)}"
             data-author="${escapeHtml(w.author)}"
             data-year="${escapeHtml(w.year)}"
             data-order="${escapeHtml(w.order)}"
             data-tier="${escapeHtml(w.tier)}"
             data-selection="${escapeHtml(w.work.selection || "")}"
             ${w.sourceUrl ? `data-sourceurl="${escapeHtml(w.sourceUrl)}"` : ""}
             id="wk_${escapeHtml(hash32(w.key))}"
        >
          <div class="workCheck">
            <input type="checkbox" ${checked ? "checked" : ""} aria-label="complete checkbox" data-action="toggleComplete" />
          </div>

          <div class="workMain">
            <p class="workTitle">${escapeHtml(title)}</p>
            <div class="workSub">
              <div class="tagRow">
                <span class="pill">Year ${escapeHtml(w.year)}</span>
                <span class="pill">Order ${escapeHtml(w.order)}</span>
                <span class="pill">${escapeHtml(w.tier)}</span>
                <span class="pill">Notes ${escapeHtml(noteCount)}</span>
              </div>
              ${subLines.length ? `<div>${subLines.map(escapeHtml).join("<br>")}</div>` : ""}
            </div>
          </div>

          <div class="workDrawer"><div>
            <div class="workActions">
              <button class="btn" type="button" data-action="openOpenAlex">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                OpenAlex
              </button>
              <button class="btn" type="button" data-action="openWikipedia">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path><path d="M2 12h20"></path></svg>
                Wikipedia
              </button>
              <button class="btn" type="button" data-action="openWikiSearch">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                WikiSearch
              </button>
              ${w.sourceUrl ? `<button class="btn" type="button" data-action="openSource">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                Source
              </button>` : ""}
              <button class="btn" type="button" data-action="openLibraryForWork">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                View in library
              </button>
              <button class="btn" type="button" data-action="newNoteFromWork">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                New note
              </button>
              <button class="btn" type="button" data-action="openNotesForBook">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                Open notes
              </button>
            </div>
          </div></div>
        </div>
      `;
    }

    /* =========================================================
       DELEGATION
       ========================================================= */
    function wireLibraryDelegation(){
      const grid = $("#libraryGrid");

      grid.onclick = (e) => {
        // Mobile: tap anywhere on card (outside buttons) toggles drawer
        if (!window.matchMedia("(hover:hover)").matches) {
          if (!e.target.closest("[data-action]") && !e.target.closest("input")) {
            const card = e.target.closest(".libCard");
            if (card) {
              const was = card.classList.contains("active");
              grid.querySelectorAll(".libCard.active").forEach(c => c.classList.remove("active"));
              if (!was) card.classList.add("active");
              return;
            }
          }
        }

        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const card = btn.closest(".libCard");
        if (!card) return;

        const title = card.dataset.title || "";
        const author = card.dataset.author || "";

        if (btn.dataset.action === "openOpenAlexLib"){
          window.open(buildOpenAlexUrl({ title, author }), "_blank", "noopener,noreferrer");
          return;
        }

        if (btn.dataset.action === "openWikipediaLib"){
          const wikiTitle = encodeURIComponent(title.replace(/\s+/g, "_"));
          window.open(`https://en.wikipedia.org/wiki/${wikiTitle}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (btn.dataset.action === "openWikiSearchLib"){
          const q = encodeURIComponent(`${title} ${author}`.trim());
          window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${q}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (btn.dataset.action === "openSourceLib"){
          const sourceUrl = card.dataset.sourceurl;
          if (sourceUrl) window.open(sourceUrl, "_blank", "noopener,noreferrer");
          return;
        }

        if (btn.dataset.action === "gotoPlanFirst"){
          const key = btn.dataset.workkey || "";
          gotoPlanWorkKey(key);
          return;
        }

        if (btn.dataset.action === "gotoPlanOcc"){
          const key = btn.dataset.workkey || "";
          gotoPlanWorkKey(key);
          return;
        }

        if (btn.dataset.action === "newNoteLib"){
          openDrawer("notes");
          startNewNote({ book_tag: title, author, year:"", selection:"" });
          return;
        }

        if (btn.dataset.action === "openNotesLib"){
          openDrawer("notes");
          state.notesUI.tag = title;
          $("#noteTagFilter").value = title;
          renderNotesList();
          return;
        }

        if (btn.dataset.action === "addToBundle"){
          const selectedBundleId = $("#libBundleSelect").value;
          const selectedPage = Number($("#libBundlePageSelect").value) || 1;
          const sourceUrl = card.dataset.sourceurl || "";

          if (!selectedBundleId){
            alert("Please select a bundle from the dropdown first.");
            return;
          }

          const bundle = getBundleById(selectedBundleId);
          if (!bundle){
            alert("Bundle not found. Please select a valid bundle.");
            return;
          }

          if (bundle.isDefault){
            alert("Cannot add to the default Ten-Year Reading Plan. Please create or select a user bundle.");
            return;
          }

          const success = addBookToBundle(selectedBundleId, selectedPage, {
            title,
            author,
            sourceUrl
          });

          if (success){
            alert(`Added "${title}" to "${bundle.plan_name}" (Page ${selectedPage})`);
            updateLibBundlePageDropdown();
          } else {
            alert("Failed to add book to bundle.");
          }
          return;
        }
      };
    }

    function wirePlanDelegation(){
      const grid = $("#planGrid");

      grid.onclick = (e) => {
        // Mobile: tap anywhere on work row (outside buttons/checkboxes) toggles drawer
        if (!window.matchMedia("(hover:hover)").matches) {
          if (!e.target.closest("[data-action]") && !e.target.closest("input")) {
            const row = e.target.closest(".workRow");
            if (row) {
              const was = row.classList.contains("active");
              grid.querySelectorAll(".workRow.active").forEach(r => r.classList.remove("active"));
              if (!was) row.classList.add("active");
              return;
            }
          }
        }

        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "markBlockDone" || action === "markBlockUndone"){
          const block = btn.closest(".readingBlock");
          if (!block) return;
          const workRows = Array.from(block.querySelectorAll(".workRow"));
          for (const row of workRows){
            const key = row.dataset.workkey;
            state.checks[key] = (action === "markBlockDone");
          }
          saveChecks(state.checks);
          renderAll();
          return;
        }

        const row = btn.closest(".workRow");
        if (!row) return;

        if (action === "openOpenAlex"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          window.open(buildOpenAlexUrl({ title, author }), "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openWikipedia"){
          const title = row.dataset.book || "";
          const wikiTitle = encodeURIComponent(title.replace(/\s+/g, "_"));
          window.open(`https://en.wikipedia.org/wiki/${wikiTitle}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openWikiSearch"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          const q = encodeURIComponent(`${title} ${author}`.trim());
          window.open(`https://en.wikipedia.org/wiki/Special:Search?search=${q}`, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openSource"){
          const sourceUrl = row.dataset.sourceurl;
          if (sourceUrl) window.open(sourceUrl, "_blank", "noopener,noreferrer");
          return;
        }

        if (action === "openLibraryForWork"){
          const title = row.dataset.book || "";
          const author = row.dataset.author || "";
          gotoLibraryWork(author, title);
          return;
        }

        if (action === "newNoteFromWork" || action === "openNotesForBook"){
          const ctx = getWorkContextFromRow(row);

          if (action === "newNoteFromWork"){
            openDrawer("notes");
            startNewNote(ctx);
          } else {
            openDrawer("notes");
            state.notesUI.tag = ctx.book_tag;
            $("#noteTagFilter").value = ctx.book_tag;
            renderNotesList();
          }
          return;
        }
      };

      grid.onchange = (e) => {
        const cb = e.target.closest('input[type="checkbox"][data-action="toggleComplete"]');
        if (!cb) return;
        const row = cb.closest(".workRow");
        const key = row.dataset.workkey;
        state.checks[key] = cb.checked;
        saveChecks(state.checks);
        renderAll();
      };

      // (year expand/collapse removed — single year view)
    }

    /* =========================================================
       CROSS REFERENCES
       ========================================================= */
    function gotoPlanWorkKey(workkey){
      if (!workkey) return;

      setView("plan");

      // Switch stepper to the target year then scroll to the work row
      const fw = state.flatWorks.find(x => x.key === workkey);
      if (fw){
        state.filters.year = String(fw.year);
        updateYearStepper();
        renderPlan();
      }

      requestAnimationFrame(() => {
        const id = "wk_" + hash32(workkey);
        const el = document.getElementById(id);
        if (el){
          el.scrollIntoView({ behavior:"smooth", block:"start" });
          flashEl(el);
        }
      });
    }

    function gotoLibraryWork(author, title){
      setView("library");
      renderLibrary();

      requestAnimationFrame(() => {
        const libKey = `${author}||${title}`.toLowerCase();
        const id = "lib_" + hash32(libKey);
        const el = document.getElementById(id);
        if (el){
          el.scrollIntoView({ behavior:"smooth", block:"start" });
          flashEl(el);
        } else {
          // Fallback: try to find by dataset (in case id mismatch)
          const fallback = document.querySelector(`.libCard[data-libkey="${CSS.escape(libKey)}"]`);
          if (fallback){
            fallback.scrollIntoView({ behavior:"smooth", block:"start" });
            flashEl(fallback);
          }
        }
      });
    }

    function getWorkContextFromRow(row){
      const book = row.dataset.book || "";
      const author = row.dataset.author || "";
      const year = Number(row.dataset.year) || "";
      const selection = row.dataset.selection || "";
      return { book_tag: book, author, year, selection };
    }

    /* =========================================================
       DRAWERS
       ========================================================= */
    function openDrawer(which){
      state.drawer.open = true;
      state.drawer.which = which;

      $("#overlay").classList.add("open");
      $("#overlay").setAttribute("aria-hidden", "false");

      if (which === "notes"){
        $("#notesDrawer").classList.add("open");
        $("#notesDrawer").setAttribute("aria-hidden", "false");
        $("#oaDrawer").classList.remove("open");
        $("#oaDrawer").setAttribute("aria-hidden", "true");
        renderNotesList();
      } else {
        $("#oaDrawer").classList.add("open");
        $("#oaDrawer").setAttribute("aria-hidden", "false");
        $("#notesDrawer").classList.remove("open");
        $("#notesDrawer").setAttribute("aria-hidden", "true");
        hideEditor();
        updateOpenAlexPreview();
      }
    }

    function closeDrawer(){
      state.drawer.open = false;
      state.drawer.which = null;

      $("#overlay").classList.remove("open");
      $("#overlay").setAttribute("aria-hidden", "true");

      $("#notesDrawer").classList.remove("open");
      $("#notesDrawer").setAttribute("aria-hidden", "true");

      $("#oaDrawer").classList.remove("open");
      $("#oaDrawer").setAttribute("aria-hidden", "true");

      hideEditor();
    }

    /* =========================================================
       NOTES (kept same behavior)
       ========================================================= */
    function filteredNotes(){
      const q = normalizeText(state.notesUI.search);
      const tag = state.notesUI.tag;

      let notes = state.notes.slice();

      if (tag !== "all"){
        notes = notes.filter(n => n.book_tag === tag);
      }
      if (q){
        notes = notes.filter(n => {
          const hay = normalizeText(`${n.title} ${n.body} ${n.book_tag} ${n.author} ${n.selection}`);
          return hay.includes(q);
        });
      }
      notes.sort((a,b)=> (b.updated_at || "").localeCompare(a.updated_at || ""));
      return notes;
    }

    function renderNotesList(){
      const tagSel = $("#noteTagFilter");
      if (tagSel && tagSel.value !== state.notesUI.tag) tagSel.value = state.notesUI.tag;

      const list = $("#noteList");
      const notes = filteredNotes();

      if (!notes.length){
        list.innerHTML = `
          <div class="noteItem">
            <div class="noteItemHead">
              <p class="noteItemTitle">No notes</p>
              <div class="noteItemMeta"><span>Create one</span></div>
            </div>
            <div class="noteItemPreview">Use “New note” or click “New note” on a work.</div>
          </div>
        `;
      } else {
        list.innerHTML = notes.map(n => noteItemHtml(n)).join("");
      }

      list.onclick = (e) => {
        const item = e.target.closest("[data-noteid]");
        if (!item) return;
        const id = item.dataset.noteid;
        startEditNote(id);
      };
    }

    function noteItemHtml(n){
      const title = n.title ? escapeHtml(n.title) : "Untitled note";
      const book = n.book_tag ? escapeHtml(n.book_tag) : "—";
      const year = n.year ? `Year ${escapeHtml(n.year)}` : "—";
      const updated = n.updated_at ? new Date(n.updated_at).toLocaleString() : "";
      const preview = (n.body || "").slice(0, 220);

      const pills = [
        `<span class="pill">${book}</span>`,
        `<span class="pill">${year}</span>`,
        n.author ? `<span class="pill">${escapeHtml(n.author)}</span>` : ""
      ].filter(Boolean).join("");

      return `
        <div class="noteItem" data-noteid="${escapeHtml(n.id)}">
          <div class="noteItemHead">
            <p class="noteItemTitle">${title}</p>
            <div class="noteItemMeta">
              <span>${escapeHtml(updated)}</span>
            </div>
          </div>
          <div class="tagRow">${pills}</div>
          <div class="noteItemPreview">${escapeHtml(preview)}${(n.body||"").length>220 ? "…" : ""}</div>
        </div>
      `;
    }

    function showEditor(){
      $("#noteEditor").style.display = "grid";
      $("#noteList").style.display = "none";
    }
    function hideEditor(){
      $("#noteEditor").style.display = "none";
      $("#noteList").style.display = "block";
      state.notesUI.editingId = null;
    }

    function startNewNote(ctx){
      const id = uid();
      state.notesUI.editingId = id;

      $("#editTitle").value = ctx.book_tag ? `${ctx.book_tag} — ` : "";
      $("#editBookTag").value = ctx.book_tag && state.tagsUniverse.includes(ctx.book_tag) ? ctx.book_tag : (state.tagsUniverse[0] || "");
      $("#editYear").value = ctx.year ? String(ctx.year) : "";
      $("#editAuthor").value = ctx.author || "";
      $("#editSelection").value = ctx.selection || "";
      $("#editBody").value = "";

      $("#editMeta").textContent = "New note — not saved yet.";
      showEditor();
      $("#editTitle").focus();
    }

    function startEditNote(id){
      const n = state.notes.find(x => x.id === id);
      if (!n) return;

      state.notesUI.editingId = id;

      $("#editTitle").value = n.title || "";
      $("#editBookTag").value = n.book_tag && state.tagsUniverse.includes(n.book_tag) ? n.book_tag : (state.tagsUniverse[0] || "");
      $("#editYear").value = n.year ? String(n.year) : "";
      $("#editAuthor").value = n.author || "";
      $("#editSelection").value = n.selection || "";
      $("#editBody").value = n.body || "";

      const meta = `Saved • Created: ${n.created_at ? new Date(n.created_at).toLocaleString() : "—"} • Updated: ${n.updated_at ? new Date(n.updated_at).toLocaleString() : "—"}`;
      $("#editMeta").textContent = meta;

      showEditor();
      $("#editBody").focus();
    }

    function saveEditorNote(){
      const id = state.notesUI.editingId;
      if (!id) return;

      const title = $("#editTitle").value.trim();
      const book_tag = $("#editBookTag").value;
      const year = Number($("#editYear").value) || null;
      const author = $("#editAuthor").value.trim();
      const selection = $("#editSelection").value.trim();
      const body = $("#editBody").value;

      const existingIdx = state.notes.findIndex(n => n.id === id);

      if (existingIdx === -1){
        const note = {
          id,
          title: title || `Note — ${book_tag}`,
          book_tag,
          year,
          author,
          selection,
          body,
          created_at: nowIso(),
          updated_at: nowIso()
        };
        state.notes.unshift(note);
      } else {
        const n = state.notes[existingIdx];
        n.title = title || `Note — ${book_tag}`;
        n.book_tag = book_tag;
        n.year = year;
        n.author = author;
        n.selection = selection;
        n.body = body;
        n.updated_at = nowIso();
      }

      saveNotes(state.notes);

      if (state.notesUI.tag !== "all" && state.notesUI.tag !== book_tag){
        state.notesUI.tag = book_tag;
        $("#noteTagFilter").value = book_tag;
      }

      renderNotesList();
      hideEditor();
      renderAll();
    }

    function deleteEditorNote(){
      const id = state.notesUI.editingId;
      if (!id) return;
      if (!confirm("Delete this note?")) return;

      state.notes = state.notes.filter(n => n.id !== id);
      saveNotes(state.notes);

      renderNotesList();
      hideEditor();
      renderAll();
    }

    function exportNotes(){
      const payload = { exported_at: nowIso(), notes: state.notes };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `reading-notes-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    async function importNotesFile(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        let notesIn = [];
        if (Array.isArray(parsed)) notesIn = parsed;
        else if (parsed && Array.isArray(parsed.notes)) notesIn = parsed.notes;
        else throw new Error("Import must be an array of notes, or { notes: [...] }");

        const existing = new Map(state.notes.map(n => [n.id, n]));
        for (const n of notesIn){
          if (!n || !n.id) continue;
          existing.set(n.id, {
            id: String(n.id),
            title: String(n.title || "").trim() || `Note — ${String(n.book_tag || "Unknown")}`,
            book_tag: String(n.book_tag || "").trim(),
            year: (n.year === null || n.year === undefined || n.year === "") ? null : Number(n.year),
            author: String(n.author || "").trim(),
            selection: String(n.selection || "").trim(),
            body: String(n.body || ""),
            created_at: n.created_at ? String(n.created_at) : nowIso(),
            updated_at: n.updated_at ? String(n.updated_at) : nowIso()
          });
        }

        state.notes = Array.from(existing.values()).sort((a,b)=> (b.updated_at||"").localeCompare(a.updated_at||""));
        saveNotes(state.notes);

        $("#importFile").value = "";

        renderAll();
        alert("Notes imported.");
      } catch(err){
        alert(`Import failed: ${err.message}`);
      }
    }

    /* =========================================================
       OPENALEX UI
       ========================================================= */
    function syncOpenAlexUIFromState(){
      $("#oaTarget").value = state.openalex.target;
      $("#oaType").value = state.openalex.type;
      $("#oaIsOa").checked = !!state.openalex.is_oa;
      $("#oaLang").value = state.openalex.lang;
      $("#oaFromYear").value = state.openalex.from_year || "";
      $("#oaToYear").value = state.openalex.to_year || "";
      $("#oaMinCites").value = state.openalex.min_cites || "";
      $("#oaSort").value = state.openalex.sort;
      $("#oaPerPage").value = String(state.openalex.per_page || 25);
      $("#oaTestQ").value = state.openalex.test_q || "Candide";
    }

    function updateOpenAlexPreview(){
      $("#oaPreview").textContent = buildOpenAlexPreviewUrl();
    }

    function persistOA(updatePreview=true){
      saveOpenAlexSettings(state.openalex);
      if (updatePreview) updateOpenAlexPreview();
      else $("#oaPreview").textContent = buildOpenAlexPreviewUrl();
    }

    /* =========================================================
       WIRE UI
       ========================================================= */
    function wireUI(){
      // Tabs
      $("#tabLibrary").addEventListener("click", ()=> setView("library"));
      $("#tabPlan").addEventListener("click", ()=> setView("plan"));
      $("#tabBundles").addEventListener("click", ()=> setView("bundles"));

      // Global drawer buttons
      $("#openNotesBtn").addEventListener("click", () => openDrawer("notes"));
      $("#openOpenAlexBtn").addEventListener("click", () => openDrawer("openalex"));

      $("#closeNotesBtn").addEventListener("click", closeDrawer);
      $("#oaCloseBtn").addEventListener("click", closeDrawer);
      $("#overlay").addEventListener("click", closeDrawer);

      document.addEventListener("keydown", (e)=>{
        if (e.key === "Escape" && state.drawer.open) closeDrawer();
      });

      // Progress popup hover/click handling
      const progressWrap = $("#progressBadgeWrap");
      const progressPopup = $("#progressPopup");
      const hoverMediaQuery = window.matchMedia("(hover:hover)");
      
      // Desktop: show on hover
      progressWrap.addEventListener("mouseenter", () => {
        if (hoverMediaQuery.matches) {
          updateProgressPopup();
          progressPopup.classList.add("show");
          progressPopup.setAttribute("aria-hidden", "false");
        }
      });
      progressWrap.addEventListener("mouseleave", () => {
        if (hoverMediaQuery.matches) {
          progressPopup.classList.remove("show");
          progressPopup.setAttribute("aria-hidden", "true");
        }
      });
      
      // Mobile: toggle on click
      $("#progressBadge").addEventListener("click", (e) => {
        if (!hoverMediaQuery.matches) {
          e.stopPropagation();
          updateProgressPopup();
          progressPopup.classList.toggle("show");
          progressPopup.setAttribute("aria-hidden", progressPopup.classList.contains("show") ? "false" : "true");
        }
      });
      
      // Close popup when clicking outside
      document.addEventListener("click", (e) => {
        if (!progressWrap.contains(e.target)) {
          progressPopup.classList.remove("show");
          progressPopup.setAttribute("aria-hidden", "true");
        }
      });

      // Library filters
      $("#libQ").addEventListener("input", e => { state.filters.libQ = e.target.value; renderLibrary(); });
      $("#libSort").addEventListener("change", e => { state.filters.libSort = e.target.value; renderLibrary(); });
      $("#libTierPresence").addEventListener("change", e => { state.filters.libTierPresence = e.target.value; renderLibrary(); });
      $("#libShow").addEventListener("change", e => { state.filters.libShow = e.target.value; renderLibrary(); });
      $("#libBundleSelect").addEventListener("change", e => { updateLibBundlePageDropdown(); });
      $("#libResetBtn").addEventListener("click", ()=> {
        state.filters.libQ = "";
        state.filters.libSort = "author";
        state.filters.libTierPresence = "all";
        state.filters.libShow = "all";
        $("#libQ").value = "";
        $("#libSort").value = "author";
        $("#libTierPresence").value = "all";
        $("#libShow").value = "all";
        renderLibrary();
      });

      // Plan filters
      $("#q").addEventListener("input", e => { state.filters.q = e.target.value; renderPlan(); updateProgressBadge(); });
      $("#yearPrev").addEventListener("click", () => {
        const idx = state.availableYears.indexOf(Number(state.filters.year));
        if (idx > 0){ state.filters.year = String(state.availableYears[idx - 1]); updateYearStepper(); renderPlan(); }
      });
      $("#yearNext").addEventListener("click", () => {
        const idx = state.availableYears.indexOf(Number(state.filters.year));
        if (idx < state.availableYears.length - 1){ state.filters.year = String(state.availableYears[idx + 1]); updateYearStepper(); renderPlan(); }
      });
      $("#tierSel").addEventListener("change", e => { state.filters.tier = e.target.value; renderPlan(); });
      $("#sortSel").addEventListener("change", e => { state.filters.sort = e.target.value; renderPlan(); });
      $("#onlyIncomplete").addEventListener("change", e => { state.filters.onlyIncomplete = e.target.checked; renderPlan(); });

      $("#resetChecksBtn").addEventListener("click", () => {
        if (!confirm("Reset all checkboxes? This cannot be undone.")) return;
        state.checks = {};
        saveChecks(state.checks);
        renderAll();
      });

      // Bundle controls
      $("#bundleSelect").addEventListener("change", e => {
        state.activeBundleId = e.target.value;
        saveActiveBundle(state.activeBundleId);
        state.filters.bundleYear = "1";
        updateBundlePageDropdown();
        renderBundles();
      });

      $("#bundlePagePrev").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle) return;
        const years = (bundle.years || []).map(y => Number(y.year)).filter(n => Number.isFinite(n)).sort((a,b) => a - b);
        const idx = years.indexOf(Number(state.filters.bundleYear));
        if (idx > 0){
          state.filters.bundleYear = String(years[idx - 1]);
          updateBundlePageDropdown();
          renderBundles();
        }
      });

      $("#bundlePageNext").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle) return;
        const years = (bundle.years || []).map(y => Number(y.year)).filter(n => Number.isFinite(n)).sort((a,b) => a - b);
        const idx = years.indexOf(Number(state.filters.bundleYear));
        if (idx < years.length - 1){
          state.filters.bundleYear = String(years[idx + 1]);
          updateBundlePageDropdown();
          renderBundles();
        }
      });

      $("#newBundleBtn").addEventListener("click", () => {
        const name = prompt("Enter a name for your new bundle:", "My Reading Bundle");
        if (name && name.trim()){
          createNewBundle(name.trim());
          setView("bundles");
        }
      });

      $("#addBundlePageBtn").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle){
          alert("Please select a bundle first.");
          return;
        }
        if (bundle.isDefault){
          alert("Cannot add pages to the default Ten-Year Reading Plan. Please create or select a user bundle.");
          return;
        }
        addPageToBundle(bundle.id);
      });

      $("#renamePageBtn").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle){
          alert("Please select a bundle first.");
          return;
        }
        if (bundle.isDefault){
          alert("Cannot rename pages in the default Ten-Year Reading Plan.");
          return;
        }
        const currentPage = Number(state.filters.bundleYear) || 1;
        const yearObj = bundle.years?.find(y => Number(y.year) === currentPage);
        const currentName = yearObj?.name || `Page ${currentPage}`;
        const newName = prompt("Enter a new name for this page:", currentName);
        if (newName && newName.trim()){
          renameBundlePage(bundle.id, currentPage, newName.trim());
        }
      });

      $("#renameBundleBtn").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle){
          alert("Please select a bundle first.");
          return;
        }
        if (bundle.isDefault){
          alert("Cannot rename the default Ten-Year Reading Plan.");
          return;
        }
        const newName = prompt("Enter a new name for this bundle:", bundle.plan_name);
        if (newName && newName.trim()){
          renameBundle(bundle.id, newName.trim());
          $("#planName").textContent = newName.trim();
        }
      });

      $("#deleteBundleBtn").addEventListener("click", () => {
        const bundle = getActiveBundle();
        if (!bundle){
          alert("Please select a bundle first.");
          return;
        }
        if (bundle.isDefault){
          alert("Cannot delete the default Ten-Year Reading Plan.");
          return;
        }
        if (!confirm(`Delete bundle "${bundle.plan_name}"? This cannot be undone.`)) return;
        deleteBundle(bundle.id);
      });

      // Notes
      $("#noteSearch").addEventListener("input", (e)=>{ state.notesUI.search = e.target.value; renderNotesList(); });
      $("#noteTagFilter").addEventListener("change", (e)=>{ state.notesUI.tag = e.target.value; renderNotesList(); });

      $("#newNoteBtn").addEventListener("click", () => startNewNote({}));
      $("#exportNotesBtn").addEventListener("click", exportNotes);
      $("#importNotesBtn").addEventListener("click", ()=> $("#importFile").click());
      $("#importFile").addEventListener("change", importNotesFile);

      $("#saveNoteBtn").addEventListener("click", saveEditorNote);
      $("#deleteNoteBtn").addEventListener("click", deleteEditorNote);
      $("#cancelEditBtn").addEventListener("click", hideEditor);

      // OpenAlex options
      $("#oaResetBtn").addEventListener("click", () => {
        if (!confirm("Reset OpenAlex options to defaults?")) return;
        state.openalex = defaultOpenAlexSettings();
        saveOpenAlexSettings(state.openalex);
        syncOpenAlexUIFromState();
        updateOpenAlexPreview();
      });

      $("#oaTarget").addEventListener("change", (e)=>{ state.openalex.target = e.target.value; persistOA(); });
      $("#oaType").addEventListener("change", (e)=>{ state.openalex.type = e.target.value; persistOA(); });
      $("#oaIsOa").addEventListener("change", (e)=>{ state.openalex.is_oa = e.target.checked; persistOA(); });
      $("#oaLang").addEventListener("change", (e)=>{ state.openalex.lang = e.target.value; persistOA(); });
      $("#oaFromYear").addEventListener("input", (e)=>{ state.openalex.from_year = e.target.value; persistOA(false); });
      $("#oaToYear").addEventListener("input", (e)=>{ state.openalex.to_year = e.target.value; persistOA(false); });
      $("#oaMinCites").addEventListener("input", (e)=>{ state.openalex.min_cites = e.target.value; persistOA(false); });
      $("#oaSort").addEventListener("change", (e)=>{ state.openalex.sort = e.target.value; persistOA(); });
      $("#oaPerPage").addEventListener("change", (e)=>{ state.openalex.per_page = Number(e.target.value); persistOA(); });
      $("#oaTestQ").addEventListener("input", (e)=>{ state.openalex.test_q = e.target.value; persistOA(false); });

      $("#oaTestBtn").addEventListener("click", () => {
        window.open(buildOpenAlexPreviewUrl(), "_blank", "noopener,noreferrer");
      });
    }

    /* =========================================================
       BOOT
       ========================================================= */
    loadPlan();
  </script>
</body>
</html>
