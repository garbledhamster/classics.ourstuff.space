<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Great Works Navigator</title>

  <!-- Fonts: newspaper serif + clean UI sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Minimal modern reset -->
  <style>
    /* ===== Reset (compact) ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; }
    img, svg { display: block; max-width: 100%; }
    button, input, select { font: inherit; }
    a { color: inherit; }

    /* ===== Neo-brutal newspaper theme ===== */
    :root{
      --paper: #ffffff;
      --ink: #000000;
      --ink-2: #111111;
      --muted: #444444;
      --rule: #000000;
      --shadow: 8px 8px 0 var(--ink);
      --shadow-sm: 5px 5px 0 var(--ink);
      --border: 2px solid var(--ink);
      --border-thin: 1px solid var(--ink);
      --radius: 0px; /* hard edges */
      --gap: 16px;
      --max: 1200px;
    }

    body{
      background: var(--paper);
      color: var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.25;
    }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 18px;
    }

    /* Masthead */
    header.masthead{
      border-top: 6px solid var(--ink);
      border-bottom: 3px solid var(--ink);
      padding: 14px 0 12px 0;
      margin-bottom: 16px;
    }
    .mast-top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight: 900;
      letter-spacing: -0.02em;
      font-size: clamp(28px, 3.2vw, 44px);
      line-height: 1;
      text-transform: uppercase;
    }
    .dateline{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight: 600;
      font-size: 14px;
      color: var(--ink-2);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .rule{
      height: 1px;
      background: var(--ink);
      margin-top: 10px;
    }
    .subhead{
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--muted);
    }
    .badge{
      border: var(--border-thin);
      padding: 6px 10px;
      background: #fff;
      box-shadow: 3px 3px 0 var(--ink);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
      color: var(--ink);
      white-space: nowrap;
    }

    /* Controls bar */
    .controls{
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 12px;
      background: #fff;
      display: grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr;
      gap: 10px;
      align-items: end;
      margin-bottom: 16px;
    }

    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .controls{ grid-template-columns: 1fr; }
    }

    .control{
      display: grid;
      gap: 6px;
    }
    .label{
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .input, .select{
      border: var(--border);
      border-radius: var(--radius);
      padding: 10px 10px;
      background: #fff;
      outline: none;
      box-shadow: 0 0 0 0 transparent;
    }
    .input:focus, .select:focus{
      box-shadow: 0 0 0 3px #00000022;
    }

    .toggleRow{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .toggle{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      border: var(--border);
      box-shadow: 3px 3px 0 var(--ink);
      padding: 8px 10px;
      user-select: none;
      background: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
      font-weight: 800;
    }
    .toggle input{
      width: 16px; height: 16px;
      accent-color: #000;
    }

    /* Layout: newspaper columns */
    .grid{
      column-gap: 16px;
      columns: 3 320px;
    }
    @media (max-width: 980px){ .grid{ columns: 2 320px; } }
    @media (max-width: 560px){ .grid{ columns: 1 320px; } }

    /* Cards */
    .card{
      break-inside: avoid;
      border: var(--border);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow);
      margin: 0 0 16px 0;
      padding: 12px;
      position: relative;
      transition: transform 120ms ease;
    }
    .card:hover{ transform: translate(-2px, -2px); }

    .kicker{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: var(--border-thin);
      margin-bottom: 10px;
    }
    .itemNo{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight: 900;
      font-size: 20px;
      line-height: 1;
      letter-spacing: -0.02em;
    }
    .metaTiny{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 800;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      text-align: right;
    }

    .title{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight: 900;
      font-size: 20px;
      line-height: 1.1;
      margin: 0 0 8px 0;
      letter-spacing: -0.01em;
    }
    .author{
      margin: 0 0 10px 0;
      font-size: 13px;
      color: var(--ink-2);
      font-weight: 600;
    }
    .author small{
      display: block;
      color: var(--muted);
      font-weight: 600;
      margin-top: 2px;
    }

    .actions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .btn, .btnlink{
      border: var(--border);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: 3px 3px 0 var(--ink);
      padding: 8px 10px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      line-height: 1;
    }
    .btn:hover, .btnlink:hover{ transform: translate(-1px, -1px); }
    .btn:active, .btnlink:active{ transform: translate(1px, 1px); box-shadow: 1px 1px 0 var(--ink); }

    .pillrow{
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .pill{
      border: var(--border-thin);
      padding: 6px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 800;
      color: var(--muted);
      background: #fff;
    }

    /* OpenAlex section inside card */
    details.oa{
      margin-top: 10px;
      border-top: var(--border-thin);
      padding-top: 10px;
    }
    details.oa > summary{
      cursor: pointer;
      list-style: none;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    details.oa > summary::-webkit-details-marker{ display: none; }

    .oaBox{
      margin-top: 10px;
      border: var(--border);
      box-shadow: 4px 4px 0 var(--ink);
      padding: 10px;
      background: #fff;
      display: grid;
      gap: 10px;
    }
    .oaControls{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .oaControls{ grid-template-columns: 1fr; }
    }
    .oaControl{
      display: grid;
      gap: 6px;
    }
    .oaControl .select, .oaControl .input{
      padding: 9px 10px;
    }
    .oaChecks{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .oaChecks label{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ink-2);
      border: var(--border-thin);
      padding: 6px 8px;
    }
    .oaChecks input{ accent-color: #000; }

    .oaActions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .oaResults{
      border-top: var(--border-thin);
      padding-top: 10px;
      display: grid;
      gap: 8px;
    }
    .oaResult{
      border: var(--border-thin);
      padding: 10px;
      background: #fff;
    }
    .oaResult a{
      text-decoration: none;
      border-bottom: 1px solid #000;
    }
    .oaResultTitle{
      font-weight: 900;
      font-size: 13px;
      margin: 0 0 6px 0;
      font-family: Newsreader, Georgia, "Times New Roman", serif;
    }
    .oaResultMeta{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      font-weight: 800;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Footer/status */
    .status{
      margin-top: 16px;
      border-top: 3px solid var(--ink);
      padding-top: 12px;
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .error{
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 12px;
      background: #fff;
      margin-bottom: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="masthead">
      <div class="mast-top">
        <div class="brand">Great Works Navigator</div>
        <div class="dateline">
          <span id="datelineLeft">Index</span>
          <span class="mono">•</span>
          <span id="datelineRight">Loading…</span>
        </div>
      </div>
      <div class="rule"></div>
      <div class="subhead">
        <div class="badge" id="countBadge">0 works</div>
        <div class="badge">Neo-Brutal Newspaper</div>
        <div class="badge">Wiki + OpenAlex</div>
      </div>
    </header>

    <div id="errorBox" class="error" style="display:none;"></div>

    <section class="controls" aria-label="filters">
      <div class="control">
        <div class="label">Search (title/author)</div>
        <input id="q" class="input" type="search" placeholder="e.g., Plato, Republic, Candide…" autocomplete="off" />
      </div>

      <div class="control">
        <div class="label">Volume</div>
        <select id="vol" class="select">
          <option value="all">All</option>
        </select>
      </div>

      <div class="control">
        <div class="label">Era</div>
        <select id="era" class="select">
          <option value="all">All</option>
          <option value="ancient">Ancient (≤ 500)</option>
          <option value="medieval">Medieval (501–1500)</option>
          <option value="earlymodern">Early Modern (1501–1800)</option>
          <option value="modern">Modern (1801+)</option>
        </select>
      </div>

      <div class="control">
        <div class="label">Sort</div>
        <select id="sort" class="select">
          <option value="item">Item #</option>
          <option value="dateAsc">Date ↑</option>
          <option value="dateDesc">Date ↓</option>
          <option value="title">Title A→Z</option>
          <option value="author">Author A→Z</option>
        </select>
      </div>

      <div class="control" style="grid-column: 1 / -1;">
        <div class="toggleRow">
          <label class="toggle">
            <input id="onlyWithAuthors" type="checkbox" />
            Only with author
          </label>
          <label class="toggle">
            <input id="onlyWithVol" type="checkbox" />
            Only with volume
          </label>
          <span class="badge" id="shownBadge">Shown: 0</span>
        </div>
      </div>
    </section>

    <main>
      <div id="grid" class="grid" aria-live="polite"></div>
    </main>

    <footer class="status">
      <div>
        Data file: <span class="mono">./project.json</span>
      </div>
      <div>
        Tip: Open a card’s “OpenAlex research” to filter by <span class="mono">type</span>, angle, sort, and OA-only.
      </div>
    </footer>
  </div>

  <script>
    // ===== Utilities =====
    const $ = (sel, root=document) => root.querySelector(sel);

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeText(s){
      return String(s ?? "")
        .toLowerCase()
        .replace(/\s+/g, " ")
        .trim();
    }

    function yearToLabel(y){
      if (y === null || y === undefined || y === "") return "—";
      const n = Number(y);
      if (!Number.isFinite(n)) return String(y);
      if (n < 0) return `${Math.abs(n)} BCE`;
      return `${n} CE`;
    }

    function eraOf(year){
      const y = Number(year);
      if (!Number.isFinite(y)) return "unknown";
      if (y <= 500) return "ancient";
      if (y <= 1500) return "medieval";
      if (y <= 1800) return "earlymodern";
      return "modern";
    }

    function wikiUrlFromTitle(title){
      // Direct wiki page attempt (best-effort). If a title doesn't match perfectly,
      // Wikipedia will still often redirect or show suggestions.
      const slug = String(title ?? "").trim().replace(/\s+/g, "_");
      return `https://en.wikipedia.org/wiki/${encodeURIComponent(slug)}`;
    }

    function wikiSearchUrl(title){
      return `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(String(title ?? "").trim())}`;
    }

    // ===== OpenAlex URL builders (matches your required format) =====
    // Required base format example:
    // https://openalex.org/works?search=Candide&page=1&filter=title_and_abstract.search:Candide
    //
    // We extend filter with comma-separated filters like:
    // filter=title_and_abstract.search:Candide,type:review,is_oa:true
    //
    // And optionally add sort=... (OpenAlex supports this on the API; web typically accepts it too).
    //
    // Work type values (common): article, book, book-chapter, review, dissertation, report, dataset,
    // reference-entry, letter, editorial, peer-review, preprint, paratext, etc.
    const OA_TYPES = [
      { value: "all", label: "All types" },
      { value: "article", label: "Articles" },
      { value: "book", label: "Books" },
      { value: "book-chapter", label: "Book chapters" },
      { value: "review", label: "Reviews" },
      { value: "dissertation", label: "Dissertations" },
      { value: "report", label: "Reports" },
      { value: "dataset", label: "Datasets" },
      { value: "reference-entry", label: "Reference entries" },
      { value: "letter", label: "Letters" },
      { value: "editorial", label: "Editorials" },
      { value: "peer-review", label: "Peer review" },
      { value: "preprint", label: "Preprints" }
    ];

    const OA_ANGLES = [
      { value: "general", label: "General" },
      { value: "criticism", label: "Criticism / critique" },
      { value: "interpretation", label: "Interpretation" },
      { value: "reception", label: "Reception" },
      { value: "commentary", label: "Commentary" },
      { value: "translation", label: "Translation" },
      { value: "adaptation", label: "Adaptation" }
    ];

    const OA_SORTS = [
      { value: "relevance", label: "Relevance" },
      { value: "cited", label: "Most cited" },
      { value: "recent", label: "Most recent" }
    ];

    function buildOpenAlexQuery({ title, type="all", angle="general", sort="relevance", oaOnly=false }) {
      const cleanTitle = String(title ?? "").trim();
      const angleKeyword = (angle && angle !== "general") ? angle : "";

      // FILTER segments (comma-separated)
      // Always include title_and_abstract.search:<TITLE> as you requested.
      const filterSegs = [
        `title_and_abstract.search:${encodeURIComponent(cleanTitle)}`
      ];

      // Add "angle" keyword as an additional search filter to narrow the set
      if (angleKeyword) {
        filterSegs.push(`title_and_abstract.search:${encodeURIComponent(angleKeyword)}`);
      }

      // Type focus (hone in on OpenAlex work types)
      if (type && type !== "all") {
        filterSegs.push(`type:${encodeURIComponent(type)}`);
      }

      // OA focus
      if (oaOnly) {
        filterSegs.push(`is_oa:true`);
      }

      const filterStr = filterSegs.join(",");

      // SEARCH param: we include title plus optional angle keyword for extra relevance.
      const searchStr = angleKeyword ? `${cleanTitle} ${angleKeyword}` : cleanTitle;

      // Optional sort (OpenAlex API supports these; OpenAlex web generally accepts them too)
      let sortParam = "";
      if (sort === "cited") sortParam = "&sort=cited_by_count:desc";
      if (sort === "recent") sortParam = "&sort=publication_date:desc";

      // Web UI link (as you requested)
      const webUrl =
        `https://openalex.org/works` +
        `?search=${encodeURIComponent(searchStr)}` +
        `&page=1` +
        `&filter=${filterStr}` +
        sortParam;

      // API link (for previews + programmatic use)
      const apiUrl =
        `https://api.openalex.org/works` +
        `?search=${encodeURIComponent(searchStr)}` +
        `&page=1` +
        `&filter=${filterStr}` +
        sortParam;

      return { webUrl, apiUrl };
    }

    // ===== App state =====
    const state = {
      works: [],
      filtered: [],
      q: "",
      vol: "all",
      era: "all",
      sort: "item",
      onlyWithAuthors: false,
      onlyWithVol: false
    };

    const oaCache = new Map(); // apiUrl -> results array

    function setError(msg){
      const box = $("#errorBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    function clearError(){
      const box = $("#errorBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function fillVolumeOptions(works){
      const volSelect = $("#vol");
      const vols = new Set();
      for (const w of works){
        if (w.vol !== null && w.vol !== undefined && w.vol !== "") vols.add(String(w.vol));
      }
      const sorted = Array.from(vols).sort((a,b)=>Number(a)-Number(b));
      for (const v of sorted){
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = `Vol ${v}`;
        volSelect.appendChild(opt);
      }
    }

    function applyFilters(){
      const q = normalizeText(state.q);
      const vol = state.vol;
      const era = state.era;

      let out = state.works.filter(w => {
        if (state.onlyWithAuthors && !normalizeText(w.author)) return false;
        if (state.onlyWithVol && (w.vol === null || w.vol === undefined || w.vol === "")) return false;

        if (vol !== "all" && String(w.vol ?? "") !== vol) return false;

        if (era !== "all") {
          const e = eraOf(w.date);
          if (e !== era) return false;
        }

        if (q) {
          const hay = w._search;
          return hay.includes(q);
        }
        return true;
      });

      // Sort
      const s = state.sort;
      out.sort((a,b)=>{
        if (s === "item") return (a.item ?? 0) - (b.item ?? 0);
        if (s === "dateAsc") return (Number(a.date) || 0) - (Number(b.date) || 0);
        if (s === "dateDesc") return (Number(b.date) || 0) - (Number(a.date) || 0);
        if (s === "title") return String(a.title ?? "").localeCompare(String(b.title ?? ""), undefined, { sensitivity: "base" });
        if (s === "author") return String(a.author ?? "").localeCompare(String(b.author ?? ""), undefined, { sensitivity: "base" });
        return 0;
      });

      state.filtered = out;
      render();
    }

    function render(){
      const grid = $("#grid");
      const shownBadge = $("#shownBadge");
      shownBadge.textContent = `Shown: ${state.filtered.length}`;

      // Render cards
      grid.innerHTML = state.filtered.map(w => cardHtml(w)).join("");
    }

    function cardHtml(w){
      const title = escapeHtml(w.title);
      const authorRaw = String(w.author ?? "").trim();
      const authorLines = authorRaw ? authorRaw.split("\n").map(s => s.trim()).filter(Boolean) : [];
      const authorMain = authorLines[0] ? escapeHtml(authorLines[0]) : "—";
      const authorRest = authorLines.slice(1);

      const dateLabel = yearToLabel(w.date);
      const volLabel = (w.vol === null || w.vol === undefined || w.vol === "") ? "—" : `Vol ${escapeHtml(w.vol)}`;

      const wiki = wikiUrlFromTitle(w.title);
      const wikiAlt = wikiSearchUrl(w.title);

      // Default OpenAlex links (general, all types)
      const { webUrl, apiUrl } = buildOpenAlexQuery({
        title: w.title,
        type: "all",
        angle: "general",
        sort: "relevance",
        oaOnly: false
      });

      // Data attrs help us update links & preview per-card
      return `
        <article class="card" data-item="${escapeHtml(w.item)}" data-title="${escapeHtml(w.title)}">
          <div class="kicker">
            <div class="itemNo">#${escapeHtml(w.item)}</div>
            <div class="metaTiny">
              <span>${escapeHtml(volLabel)}</span>
              <span class="mono">•</span>
              <span>${escapeHtml(dateLabel)}</span>
            </div>
          </div>

          <h2 class="title">${title}</h2>

          <p class="author">
            <span>${authorMain}</span>
            ${authorRest.length ? `<small>${authorRest.map(escapeHtml).join("<br>")}</small>` : ""}
          </p>

          <div class="pillrow">
            <span class="pill">Era: ${escapeHtml(eraOf(w.date))}</span>
            <span class="pill">Date: ${escapeHtml(dateLabel)}</span>
          </div>

          <div class="actions">
            <a class="btnlink" href="${wiki}" target="_blank" rel="noopener">Wikipedia</a>
            <a class="btnlink" href="${wikiAlt}" target="_blank" rel="noopener">Wiki Search</a>
          </div>

          <details class="oa">
            <summary>
              <span>OpenAlex research</span>
              <span class="mono">+</span>
            </summary>

            <div class="oaBox">
              <div class="oaControls">
                <div class="oaControl">
                  <div class="label">Focus (type)</div>
                  <select class="select" data-oa-type>
                    ${OA_TYPES.map(t => `<option value="${escapeHtml(t.value)}">${escapeHtml(t.label)}</option>`).join("")}
                  </select>
                </div>

                <div class="oaControl">
                  <div class="label">Angle</div>
                  <select class="select" data-oa-angle>
                    ${OA_ANGLES.map(a => `<option value="${escapeHtml(a.value)}">${escapeHtml(a.label)}</option>`).join("")}
                  </select>
                </div>

                <div class="oaControl">
                  <div class="label">Sort</div>
                  <select class="select" data-oa-sort>
                    ${OA_SORTS.map(s => `<option value="${escapeHtml(s.value)}">${escapeHtml(s.label)}</option>`).join("")}
                  </select>
                </div>

                <div class="oaControl">
                  <div class="label">Quick search term</div>
                  <input class="input" data-oa-extra placeholder="optional: add keyword (e.g., 'satire')" />
                </div>
              </div>

              <div class="oaChecks">
                <label>
                  <input type="checkbox" data-oa-oaonly />
                  OA only
                </label>
                <label>
                  <input type="checkbox" data-oa-previewauto />
                  Auto-preview on change
                </label>
              </div>

              <div class="oaActions">
                <a class="btnlink" data-oa-web href="${webUrl}" target="_blank" rel="noopener">OpenAlex Web</a>
                <a class="btnlink" data-oa-api href="${apiUrl}" target="_blank" rel="noopener">API (JSON)</a>
                <button class="btn" type="button" data-oa-preview>Preview 10</button>
              </div>

              <div class="oaResults" data-oa-results style="display:none;"></div>
            </div>
          </details>
        </article>
      `;
    }

    function getCardConfig(card){
      const title = card.dataset.title || "";

      const type = $("[data-oa-type]", card).value || "all";
      const angle = $("[data-oa-angle]", card).value || "general";
      const sort = $("[data-oa-sort]", card).value || "relevance";
      const oaOnly = $("[data-oa-oaonly]", card).checked;
      const extra = normalizeText($("[data-oa-extra]", card).value || "");
      const auto = $("[data-oa-previewauto]", card).checked;

      // Extra keyword:
      // We incorporate it as an additional title_and_abstract.search filter AND as part of the search query,
      // keeping your required base filter title_and_abstract.search:<TITLE>.
      return { title, type, angle, sort, oaOnly, extra, auto };
    }

    function buildOpenAlexQueryWithExtra(cfg){
      const base = buildOpenAlexQuery(cfg);

      if (!cfg.extra) return base;

      // Manually extend to keep required URL structure + add extra filter segment.
      // We do: filter=title_and_abstract.search:<TITLE>,title_and_abstract.search:<ANGLE>,title_and_abstract.search:<EXTRA>,type:...
      // and search=<TITLE> <ANGLE> <EXTRA>
      const cleanTitle = String(cfg.title ?? "").trim();
      const angleKeyword = (cfg.angle && cfg.angle !== "general") ? cfg.angle : "";
      const extraKeyword = cfg.extra;

      const filterSegs = [
        `title_and_abstract.search:${encodeURIComponent(cleanTitle)}`
      ];
      if (angleKeyword) filterSegs.push(`title_and_abstract.search:${encodeURIComponent(angleKeyword)}`);
      if (extraKeyword) filterSegs.push(`title_and_abstract.search:${encodeURIComponent(extraKeyword)}`);
      if (cfg.type && cfg.type !== "all") filterSegs.push(`type:${encodeURIComponent(cfg.type)}`);
      if (cfg.oaOnly) filterSegs.push(`is_oa:true`);

      const filterStr = filterSegs.join(",");
      const searchStr = [cleanTitle, angleKeyword, extraKeyword].filter(Boolean).join(" ");

      let sortParam = "";
      if (cfg.sort === "cited") sortParam = "&sort=cited_by_count:desc";
      if (cfg.sort === "recent") sortParam = "&sort=publication_date:desc";

      return {
        webUrl:
          `https://openalex.org/works?search=${encodeURIComponent(searchStr)}&page=1&filter=${filterStr}${sortParam}`,
        apiUrl:
          `https://api.openalex.org/works?search=${encodeURIComponent(searchStr)}&page=1&filter=${filterStr}${sortParam}`
      };
    }

    function updateOpenAlexLinks(card){
      const cfg = getCardConfig(card);
      const { webUrl, apiUrl } = buildOpenAlexQueryWithExtra(cfg);
      $("[data-oa-web]", card).href = webUrl;
      $("[data-oa-api]", card).href = apiUrl;
    }

    async function previewOpenAlex(card){
      const resultsBox = $("[data-oa-results]", card);
      resultsBox.style.display = "block";
      resultsBox.innerHTML = `<div class="oaResult"><span class="mono">Loading…</span></div>`;

      const cfg = getCardConfig(card);
      const { apiUrl } = buildOpenAlexQueryWithExtra(cfg);

      // Add per-page=10 for the preview
      const url = apiUrl + (apiUrl.includes("?") ? "&" : "?") + "per-page=10";

      if (oaCache.has(url)){
        renderOAResults(resultsBox, oaCache.get(url));
        return;
      }

      try{
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`OpenAlex API error: ${res.status}`);
        const data = await res.json();
        const items = Array.isArray(data.results) ? data.results : [];
        oaCache.set(url, items);
        renderOAResults(resultsBox, items);
      } catch (err){
        resultsBox.innerHTML = `
          <div class="oaResult">
            <div class="oaResultTitle">Preview failed</div>
            <div class="oaResultMeta">Try opening “API (JSON)” directly. (${escapeHtml(err.message)})</div>
          </div>
        `;
      }
    }

    function renderOAResults(box, items){
      if (!items.length){
        box.innerHTML = `
          <div class="oaResult">
            <div class="oaResultTitle">No results</div>
            <div class="oaResultMeta">Try changing type/angle, or add a keyword.</div>
          </div>
        `;
        return;
      }

      box.innerHTML = items.map(w => {
        const title = escapeHtml(w.display_name || w.title || "Untitled");
        const year = escapeHtml(w.publication_year ?? "—");
        const type = escapeHtml(w.type ?? "—");
        const cites = escapeHtml(w.cited_by_count ?? 0);

        const landing =
          w.primary_location && w.primary_location.landing_page_url ? w.primary_location.landing_page_url :
          (w.id ? String(w.id).replace("https://openalex.org/", "https://openalex.org/") : "");

        const href = landing ? escapeHtml(landing) : (w.id ? escapeHtml(w.id) : "#");

        return `
          <div class="oaResult">
            <div class="oaResultTitle"><a href="${href}" target="_blank" rel="noopener">${title}</a></div>
            <div class="oaResultMeta">
              <span>${year}</span>
              <span class="mono">•</span>
              <span>${type}</span>
              <span class="mono">•</span>
              <span>${cites} cites</span>
            </div>
          </div>
        `;
      }).join("");
    }

    // ===== Events =====
    function wireControls(){
      $("#q").addEventListener("input", (e)=>{ state.q = e.target.value; applyFilters(); });
      $("#vol").addEventListener("change", (e)=>{ state.vol = e.target.value; applyFilters(); });
      $("#era").addEventListener("change", (e)=>{ state.era = e.target.value; applyFilters(); });
      $("#sort").addEventListener("change", (e)=>{ state.sort = e.target.value; applyFilters(); });
      $("#onlyWithAuthors").addEventListener("change",(e)=>{ state.onlyWithAuthors = e.target.checked; applyFilters(); });
      $("#onlyWithVol").addEventListener("change",(e)=>{ state.onlyWithVol = e.target.checked; applyFilters(); });

      // Event delegation for OpenAlex controls inside cards
      $("#grid").addEventListener("change", (e)=>{
        const card = e.target.closest(".card");
        if (!card) return;

        if (e.target.matches("[data-oa-type], [data-oa-angle], [data-oa-sort], [data-oa-oaonly], [data-oa-previewauto]")) {
          updateOpenAlexLinks(card);
          const cfg = getCardConfig(card);
          if (cfg.auto) previewOpenAlex(card);
        }
      });

      $("#grid").addEventListener("input", (e)=>{
        const card = e.target.closest(".card");
        if (!card) return;

        if (e.target.matches("[data-oa-extra]")) {
          updateOpenAlexLinks(card);
          const cfg = getCardConfig(card);
          if (cfg.auto) {
            // small debounce per card
            clearTimeout(card._oaDebounce);
            card._oaDebounce = setTimeout(()=> previewOpenAlex(card), 250);
          }
        }
      });

      $("#grid").addEventListener("click", (e)=>{
        const card = e.target.closest(".card");
        if (!card) return;

        if (e.target.matches("[data-oa-preview]")) {
          e.preventDefault();
          updateOpenAlexLinks(card);
          previewOpenAlex(card);
        }
      });

      // Cosmetic: summary +/- toggle
      $("#grid").addEventListener("toggle", (e)=>{
        const details = e.target;
        if (details && details.matches("details.oa")) {
          const summary = details.querySelector("summary .mono");
          if (summary) summary.textContent = details.open ? "−" : "+";
        }
      });
    }

    // ===== Load =====
    async function load(){
      try{
        clearError();
        const res = await fetch("./project.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`Could not load project.json (${res.status})`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("project.json must be a JSON array of works.");

        // Normalize
        const works = data.map(w => {
          const title = String(w.title ?? "").trim();
          const author = (w.author === null || w.author === undefined) ? "" : String(w.author);
          const vol = (w.vol === null || w.vol === undefined || w.vol === "") ? null : w.vol;
          const date = (w.date === null || w.date === undefined || w.date === "") ? null : Number(w.date);
          const item = (w.item === null || w.item === undefined) ? null : Number(w.item);

          const search = normalizeText(`${title} ${author} ${vol ?? ""} ${date ?? ""} ${item ?? ""}`);

          return { title, author, vol, date, item, _search: search };
        });

        state.works = works;

        fillVolumeOptions(works);
        $("#countBadge").textContent = `${works.length} works`;

        // Dateline
        const now = new Date();
        const dateStr = now.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });
        $("#datelineLeft").textContent = "Great Works Index";
        $("#datelineRight").textContent = dateStr;

        wireControls();
        applyFilters();
      } catch (err){
        setError(`LOAD ERROR: ${err.message}`);
      }
    }

    load();
  </script>
</body>
</html>
