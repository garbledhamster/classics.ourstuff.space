<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Ten-Year Great Works Reading Guide</title>

  <!-- Neo-brutal newspaper fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; }
    img, svg { display: block; max-width: 100%; }
    button, input, select, textarea { font: inherit; }
    a { color: inherit; }

    /* ===== Neo-brutal newspaper theme (B/W, hard edges) ===== */
    :root{
      --paper:#fff;
      --ink:#000;
      --ink2:#111;
      --muted:#444;
      --border:2px solid var(--ink);
      --borderThin:1px solid var(--ink);
      --shadow:8px 8px 0 var(--ink);
      --shadowSm:5px 5px 0 var(--ink);
      --shadowXs:3px 3px 0 var(--ink);
      --gap:16px;
      --max:1200px;
      --radius:0px; /* HARD EDGES */
    }

    body{
      background:var(--paper);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.25;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:18px;
    }

    /* Masthead */
    header.masthead{
      border-top:6px solid var(--ink);
      border-bottom:3px solid var(--ink);
      padding:14px 0 12px 0;
      margin-bottom:16px;
    }
    .mast-top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:clamp(26px,3vw,44px);
      line-height:1;
      text-transform:uppercase;
    }
    .dateline{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:600;
      font-size:14px;
      color:var(--ink2);
      text-transform:uppercase;
      letter-spacing:0.06em;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .rule{ height:1px; background:var(--ink); margin-top:10px; }
    .subhead{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      border:var(--borderThin);
      padding:6px 10px;
      background:#fff;
      box-shadow:var(--shadowXs);
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      color:var(--ink);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* Controls */
    .controls{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:12px;
      background:#fff;
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
      margin-bottom:16px;
    }
    @media (max-width:980px){ .controls{ grid-template-columns: 1fr 1fr; } }
    @media (max-width:560px){ .controls{ grid-template-columns: 1fr; } }

    .control{ display:grid; gap:6px; }
    .label{
      font-size:12px;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    .input, .select{
      border:var(--border);
      border-radius:var(--radius);
      padding:10px;
      background:#fff;
      outline:none;
    }
    .input:focus, .select:focus{
      box-shadow:0 0 0 3px #00000022;
    }

    .rowWide{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:var(--border);
      box-shadow:var(--shadowXs);
      padding:8px 10px;
      background:#fff;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
      font-weight:900;
      user-select:none;
    }
    .toggle input{ width:16px; height:16px; accent-color:#000; }

    .btn, .btnlink{
      border:var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadowXs);
      padding:8px 10px;
      text-decoration:none;
      font-size:12px;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      line-height:1;
    }
    .btn:hover, .btnlink:hover{ transform: translate(-1px,-1px); }
    .btn:active, .btnlink:active{ transform: translate(1px,1px); box-shadow:1px 1px 0 var(--ink); }

    /* Plan layout */
    .grid{
      column-gap:16px;
      columns: 2 420px;
    }
    @media (max-width:980px){ .grid{ columns: 1 420px; } }

    /* Year card */
    .yearCard{
      break-inside: avoid;
      border:var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadow);
      margin:0 0 16px 0;
      padding:12px;
    }
    .yearHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:var(--borderThin);
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .yearTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:22px;
      letter-spacing:-0.01em;
      margin:0;
      text-transform:uppercase;
    }
    .yearMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .readingBlock{
      border:var(--borderThin);
      padding:10px;
      margin-top:10px;
      background:#fff;
    }
    .readingHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-bottom:var(--borderThin);
      padding-bottom:8px;
      margin-bottom:8px;
    }
    .readingLeft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
    }
    .order{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:18px;
      line-height:1;
    }
    .author{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:12px;
    }
    .tier{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      background:#fff;
    }
    .marker{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      background:#fff;
    }

    .worksList{
      display:grid;
      gap:8px;
    }
    .workRow{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:start;
      border:var(--borderThin);
      padding:10px;
      background:#fff;
    }
    .workCheck{
      display:flex;
      align-items:center;
      padding-top:2px;
    }
    .workCheck input{
      width:18px; height:18px;
      accent-color:#000;
    }
    .workMain{
      display:grid;
      gap:6px;
      min-width:0;
    }
    .workTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      font-size:16px;
      margin:0;
      line-height:1.1;
    }
    .workSub{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      line-height:1.2;
      display:grid;
      gap:4px;
    }
    .tagRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .pill{
      border:var(--borderThin);
      padding:4px 8px;
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .workActions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }

    /* Progress bar (brutal) */
    .bar{
      height:12px;
      border:var(--borderThin);
      background:#fff;
      position:relative;
      width: 180px;
      max-width: 100%;
    }
    .bar > span{
      display:block;
      height:100%;
      background:#000;
      width:0%;
    }

    /* Errors */
    .error{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:12px;
      background:#fff;
      margin-bottom:16px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }

    /* ===== Notes Drawer ===== */
    .drawerOverlay{
      position:fixed;
      inset:0;
      background: #00000055;
      display:none;
      z-index:50;
    }
    .drawer{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:min(520px, 94vw);
      background:#fff;
      border-left:var(--border);
      box-shadow: -10px 0 0 #000;
      transform: translateX(105%);
      transition: transform 160ms ease;
      z-index:60;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerOverlay.open{ display:block; }

    .drawerHeader{
      padding:12px;
      border-bottom:var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .drawerTitle{
      font-family: Newsreader, Georgia, "Times New Roman", serif;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:-0.01em;
      font-size:20px;
      margin:0;
    }
    .drawerBody{
      padding:12px;
      overflow:auto;
      display:grid;
      gap:12px;
    }

    .noteTools{
      border:var(--border);
      box-shadow:var(--shadowSm);
      padding:10px;
      display:grid;
      gap:10px;
      background:#fff;
    }
    .noteToolsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){ .noteToolsRow{ grid-template-columns: 1fr; } }

    .noteList{
      border:var(--border);
      box-shadow:var(--shadowSm);
      background:#fff;
    }
    .noteItem{
      border-top:var(--borderThin);
      padding:10px;
      display:grid;
      gap:6px;
    }
    .noteItem:first-child{ border-top:none; }
    .noteItemHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .noteItemTitle{
      font-weight:900;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin:0;
    }
    .noteItemMeta{
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.05em;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .noteItemPreview{
      color:#111;
      font-size:13px;
      line-height:1.25;
      white-space:pre-wrap;
      max-height: 5.2em;
      overflow:hidden;
    }

    .editor{
      border:var(--border);
      box-shadow:var(--shadowSm);
      background:#fff;
      padding:10px;
      display:grid;
      gap:10px;
    }
    .textarea{
      width:100%;
      min-height: 180px;
      border:var(--border);
      border-radius:var(--radius);
      padding:10px;
      outline:none;
      resize: vertical;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.35;
    }
    .textarea:focus{ box-shadow:0 0 0 3px #00000022; }

    .help{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      line-height:1.2;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="masthead">
      <div class="mast-top">
        <div class="brand">Reading Guide</div>
        <div class="dateline">
          <span id="planName">Ten-Year Plan</span>
          <span class="mono">•</span>
          <span id="today">Loading…</span>
        </div>
      </div>
      <div class="rule"></div>
      <div class="subhead">
        <div class="badge" id="countBadge">0 readings</div>
        <div class="badge" id="progressBadge">Progress: 0%</div>
        <div class="badge">
          <button class="btn" id="openNotesBtn" type="button">Notes Drawer</button>
        </div>
      </div>
    </header>

    <div id="errorBox" class="error" style="display:none;"></div>

    <section class="controls" aria-label="filters">
      <div class="control">
        <div class="label">Search (title/author)</div>
        <input id="q" class="input" type="search" placeholder="e.g., Plato, Republic, Aristotle…" autocomplete="off" />
      </div>

      <div class="control">
        <div class="label">Year</div>
        <select id="yearSel" class="select">
          <option value="all">All</option>
        </select>
      </div>

      <div class="control">
        <div class="label">Tier</div>
        <select id="tierSel" class="select">
          <option value="all">All</option>
          <option value="core">Core</option>
          <option value="supplemental">Supplemental</option>
        </select>
      </div>

      <div class="control">
        <div class="label">Sort</div>
        <select id="sortSel" class="select">
          <option value="plan">Plan order</option>
          <option value="author">Author A→Z</option>
          <option value="title">Title A→Z</option>
        </select>
      </div>

      <div class="rowWide">
        <label class="toggle">
          <input id="onlyIncomplete" type="checkbox" />
          Only incomplete
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn" id="expandAllBtn" type="button">Expand all</button>
          <button class="btn" id="collapseAllBtn" type="button">Collapse all</button>
          <button class="btn" id="resetChecksBtn" type="button">Reset checks</button>
        </div>
      </div>
    </section>

    <main>
      <div id="grid" class="grid" aria-live="polite"></div>
    </main>

    <footer style="margin-top:16px; border-top:3px solid #000; padding-top:12px; color:#444; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <div>Data file: <span class="mono">./reading.json</span></div>
      <div>Storage: <span class="mono">localStorage</span> (checkboxes + notes)</div>
    </footer>
  </div>

  <!-- Notes Drawer -->
  <div id="drawerOverlay" class="drawerOverlay" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" aria-label="Notes drawer" aria-hidden="true">
    <div class="drawerHeader">
      <h2 class="drawerTitle">Notes</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="newNoteBtn" type="button">New note</button>
        <button class="btn" id="closeDrawerBtn" type="button">Close</button>
      </div>
    </div>

    <div class="drawerBody">
      <section class="noteTools">
        <div class="help">Search notes + filter by book tag. Create notes from readings or here.</div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Search (title/body)</div>
            <input id="noteSearch" class="input" type="search" placeholder="e.g., justice, virtue, war…" autocomplete="off" />
          </div>

          <div class="control">
            <div class="label">Filter (book tag)</div>
            <select id="noteTagFilter" class="select">
              <option value="all">All</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="exportNotesBtn" type="button">Export JSON</button>
          <button class="btn" id="importNotesBtn" type="button">Import JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </section>

      <section class="noteList" id="noteList" aria-label="notes list"></section>

      <section class="editor" id="noteEditor" style="display:none;" aria-label="note editor">
        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Note title</div>
            <input id="editTitle" class="input" type="text" placeholder="e.g., Republic — justice and the soul" />
          </div>
          <div class="control">
            <div class="label">Book tag</div>
            <select id="editBookTag" class="select"></select>
          </div>
        </div>

        <div class="noteToolsRow">
          <div class="control">
            <div class="label">Year</div>
            <input id="editYear" class="input" type="number" min="1" max="10" placeholder="1" />
          </div>
          <div class="control">
            <div class="label">Author</div>
            <input id="editAuthor" class="input" type="text" placeholder="e.g., Plato" />
          </div>
        </div>

        <div class="control">
          <div class="label">Selections / reference</div>
          <input id="editSelection" class="input" type="text" placeholder="e.g., Book I–II; Ch. 1–5" />
        </div>

        <div class="control">
          <div class="label">Body</div>
          <textarea id="editBody" class="textarea" placeholder="Write your note…"></textarea>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="saveNoteBtn" type="button">Save</button>
          <button class="btn" id="deleteNoteBtn" type="button">Delete</button>
          <button class="btn" id="cancelEditBtn" type="button">Cancel</button>
        </div>

        <div class="help" id="editMeta"></div>
      </section>
    </div>
  </aside>

  <script>
    /* =========================================================
       STORAGE KEYS
       ========================================================= */
    const LS_CHECKS = "greatworks.reading.checks.v1";
    const LS_NOTES  = "greatworks.reading.notes.v1";

    /* =========================================================
       HELPERS
       ========================================================= */
    const $ = (sel, root=document) => root.querySelector(sel);

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeText(s){
      return String(s ?? "").toLowerCase().replace(/\s+/g," ").trim();
    }

    function setError(msg){
      const box = $("#errorBox");
      box.style.display = "block";
      box.textContent = msg;
    }
    function clearError(){
      const box = $("#errorBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function uid(){
      // stable-enough local id
      return "n_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function nowIso(){
      return new Date().toISOString();
    }

    function safeJsonParse(str, fallback){
      try{ return JSON.parse(str); } catch { return fallback; }
    }

    function loadChecks(){
      return safeJsonParse(localStorage.getItem(LS_CHECKS) || "{}", {});
    }
    function saveChecks(obj){
      localStorage.setItem(LS_CHECKS, JSON.stringify(obj));
    }

    function loadNotes(){
      return safeJsonParse(localStorage.getItem(LS_NOTES) || "[]", []);
    }
    function saveNotes(arr){
      localStorage.setItem(LS_NOTES, JSON.stringify(arr));
    }

    function workKey({year, order, tier, author, title, selection, selections}){
      // deterministic key per work occurrence in plan
      const sel = selection ? `|${selection}` : "";
      const sels = Array.isArray(selections) ? `|${selections.join(" / ")}` : "";
      return `y${year}|o${order}|${tier}|${author}|${title}${sel}${sels}`.toLowerCase();
    }

    function humanWorkLine(w){
      const t = w.title || "Untitled";
      const parts = [];
      if (w.selection) parts.push(w.selection);
      if (Array.isArray(w.selections) && w.selections.length) parts.push(w.selections.join("; "));
      return parts.length ? `${t} — ${parts.join(" | ")}` : t;
    }

    /* =========================================================
       APP STATE
       ========================================================= */
    const state = {
      plan: null,
      flatWorks: [], // each: {year, order, tier, marker?, author, work:{title,selection,selections}, key, search}
      checks: loadChecks(),
      notes: loadNotes(),
      filters: {
        q: "",
        year: "all",
        tier: "all",
        sort: "plan",
        onlyIncomplete: false
      },
      ui: {
        expandedYears: new Set() // which year cards are expanded (details open)
      },
      notesUI: {
        open: false,
        search: "",
        tag: "all",
        editingId: null
      },
      tagsUniverse: [] // list of unique work titles (for note tagging)
    };

    /* =========================================================
       LOAD READING PLAN
       ========================================================= */
    async function loadPlan(){
      clearError();
      try{
        const res = await fetch("./reading.json", { cache:"no-store" });
        if (!res.ok) throw new Error(`Could not load reading.json (${res.status})`);
        const data = await res.json();
        if (!data || !Array.isArray(data.years)) throw new Error("reading.json must include { plan_name, years: [...] }");

        state.plan = data;
        $("#planName").textContent = data.plan_name || "Reading Plan";

        const today = new Date().toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
        $("#today").textContent = today;

        flattenPlan();
        fillYearOptions();
        buildTagsUniverse();
        wireUI();
        renderAll();
      } catch(err){
        setError(`LOAD ERROR: ${err.message}`);
      }
    }

    function flattenPlan(){
      const flat = [];
      const years = state.plan.years || [];
      for (const y of years){
        const yearNum = Number(y.year);
        const readings = y.readings || [];
        for (const r of readings){
          const order = Number(r.order);
          const tier = String(r.tier || "").toLowerCase();
          const marker = r.marker ?? "";
          const author = String(r.author || "").trim();

          const works = Array.isArray(r.works) ? r.works : [];
          for (const w of works){
            const title = String(w.title || "").trim();
            const selection = w.selection ? String(w.selection).trim() : "";
            const selections = Array.isArray(w.selections) ? w.selections.map(s=>String(s).trim()).filter(Boolean) : null;

            const key = workKey({year:yearNum, order, tier, author, title, selection, selections});
            const search = normalizeText(`${yearNum} ${order} ${tier} ${author} ${title} ${selection} ${(selections||[]).join(" ")}`);

            flat.push({
              year: yearNum,
              order,
              tier,
              marker,
              author,
              work: { title, selection, selections },
              key,
              search
            });
          }
        }
      }
      state.flatWorks = flat;

      // Count badge
      $("#countBadge").textContent = `${flat.length} works`;

      // Default expanded: Year 1 open
      state.ui.expandedYears.add(1);
    }

    function fillYearOptions(){
      const sel = $("#yearSel");
      // remove existing year options except "All"
      while (sel.options.length > 1) sel.remove(1);
      const years = (state.plan.years || []).map(y=>Number(y.year)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
      for (const y of years){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = `Year ${y}`;
        sel.appendChild(opt);
      }
    }

    function buildTagsUniverse(){
      // For notes "book tag": use unique work titles appearing in the plan
      const set = new Set();
      for (const fw of state.flatWorks){
        const t = fw.work.title;
        if (t) set.add(t);
      }
      state.tagsUniverse = Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));

      // Fill note filter dropdown
      const filterSel = $("#noteTagFilter");
      filterSel.innerHTML = `<option value="all">All</option>` + state.tagsUniverse.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      // Fill editor dropdown
      const editSel = $("#editBookTag");
      editSel.innerHTML = state.tagsUniverse.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    }

    /* =========================================================
       FILTER + SORT + GROUPING
       ========================================================= */
    function applyFilters(){
      const f = state.filters;
      const q = normalizeText(f.q);

      let items = state.flatWorks.slice();

      if (f.year !== "all"){
        const y = Number(f.year);
        items = items.filter(x => x.year === y);
      }

      if (f.tier !== "all"){
        items = items.filter(x => x.tier === f.tier);
      }

      if (q){
        items = items.filter(x => x.search.includes(q));
      }

      if (f.onlyIncomplete){
        items = items.filter(x => !state.checks[x.key]);
      }

      // Sorting
      if (f.sort === "plan"){
        items.sort((a,b)=> a.year-b.year || a.order-b.order || a.work.title.localeCompare(b.work.title));
      } else if (f.sort === "author"){
        items.sort((a,b)=> a.author.localeCompare(b.author, undefined, { sensitivity:"base" })
          || a.year-b.year || a.order-b.order || a.work.title.localeCompare(b.work.title));
      } else if (f.sort === "title"){
        items.sort((a,b)=> a.work.title.localeCompare(b.work.title, undefined, { sensitivity:"base" })
          || a.year-b.year || a.order-b.order);
      }

      return items;
    }

    function groupByYear(filtered){
      const map = new Map();
      for (const item of filtered){
        if (!map.has(item.year)) map.set(item.year, []);
        map.get(item.year).push(item);
      }
      const years = Array.from(map.keys()).sort((a,b)=>a-b);
      return years.map(y => ({ year:y, items: map.get(y) }));
    }

    /* =========================================================
       PROGRESS
       ========================================================= */
    function computeProgress(){
      const total = state.flatWorks.length;
      let done = 0;
      for (const w of state.flatWorks){
        if (state.checks[w.key]) done++;
      }
      const pct = total ? Math.round((done/total)*100) : 0;
      return { total, done, pct };
    }

    function updateProgressBadge(){
      const { total, done, pct } = computeProgress();
      $("#progressBadge").textContent = `Progress: ${pct}%`;
      // also update count badge to show done/total
      $("#countBadge").textContent = `${done}/${total} works`;
    }

    /* =========================================================
       RENDER
       ========================================================= */
    function renderAll(){
      updateProgressBadge();
      renderPlan();
      renderNotesList();
    }

    function renderPlan(){
      const grid = $("#grid");
      const filtered = applyFilters();
      const grouped = groupByYear(filtered);

      if (!grouped.length){
        grid.innerHTML = `
          <div class="yearCard">
            <div class="yearHeader">
              <h2 class="yearTitle">No matches</h2>
              <div class="yearMeta"><span>Try different filters</span></div>
            </div>
            <div class="help">Nothing matched your search/tier/year/incomplete filter.</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = grouped.map(g => yearCardHtml(g.year, g.items)).join("");

      // wire per-card events after injection
      wirePlanDelegation();
    }

    function yearCardHtml(year, items){
      // year progress among items shown (not entire year)
      const total = items.length;
      const done = items.reduce((acc,x)=> acc + (state.checks[x.key] ? 1 : 0), 0);
      const pct = total ? Math.round((done/total)*100) : 0;

      const open = state.ui.expandedYears.has(year);
      const barW = pct;

      // group items by reading block (order + author + tier + marker)
      const blocks = new Map();
      for (const it of items){
        const blockKey = `${it.order}|${it.tier}|${it.marker||""}|${it.author}`;
        if (!blocks.has(blockKey)) blocks.set(blockKey, { order: it.order, tier: it.tier, marker: it.marker, author: it.author, works: [] });
        blocks.get(blockKey).works.push(it);
      }
      const blockArr = Array.from(blocks.values()).sort((a,b)=>a.order-b.order);

      return `
        <section class="yearCard" data-year="${year}">
          <div class="yearHeader">
            <h2 class="yearTitle">Year ${year}</h2>
            <div class="yearMeta">
              <span>${done}/${total} done</span>
              <span class="mono">•</span>
              <span class="bar" aria-label="progress bar"><span style="width:${barW}%"></span></span>
            </div>
          </div>

          <details class="yearDetails" ${open ? "open" : ""}>
            <summary class="btn" style="list-style:none; width:max-content;">
              ${open ? "Collapse" : "Expand"} year
            </summary>

            <div style="margin-top:10px;">
              ${blockArr.map(b => readingBlockHtml(year, b)).join("")}
            </div>
          </details>
        </section>
      `;
    }

    function readingBlockHtml(year, block){
      const tierLabel = block.tier || "—";
      const marker = block.marker ? `<span class="marker">${escapeHtml(block.marker)}</span>` : "";
      const worksHtml = block.works.map(w => workRowHtml(w)).join("");

      return `
        <div class="readingBlock" data-year="${year}" data-order="${block.order}">
          <div class="readingHead">
            <div class="readingLeft">
              <div class="order">#${escapeHtml(block.order)}</div>
              <div class="author">${escapeHtml(block.author || "Unknown")}</div>
              <span class="tier">${escapeHtml(tierLabel)}</span>
              ${marker}
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" type="button" data-action="markBlockDone">Mark block done</button>
              <button class="btn" type="button" data-action="markBlockUndone">Mark block undone</button>
            </div>
          </div>
          <div class="worksList">
            ${worksHtml}
          </div>
        </div>
      `;
    }

    function workRowHtml(w){
      const checked = !!state.checks[w.key];
      const title = w.work.title || "Untitled";
      const sel = w.work.selection ? `Selection: ${w.work.selection}` : "";
      const sels = Array.isArray(w.work.selections) && w.work.selections.length ? `Selections: ${w.work.selections.join("; ")}` : "";
      const subLines = [sel, sels].filter(Boolean);

      // count notes for this title
      const noteCount = state.notes.filter(n => n.book_tag === title).length;

      return `
        <div class="workRow" data-workkey="${escapeHtml(w.key)}"
             data-book="${escapeHtml(title)}"
             data-author="${escapeHtml(w.author)}"
             data-year="${escapeHtml(w.year)}"
             data-order="${escapeHtml(w.order)}"
             data-tier="${escapeHtml(w.tier)}"
             data-selection="${escapeHtml(w.work.selection || "")}"
        >
          <div class="workCheck">
            <input type="checkbox" ${checked ? "checked" : ""} aria-label="complete checkbox" data-action="toggleComplete" />
          </div>

          <div class="workMain">
            <p class="workTitle">${escapeHtml(title)}</p>
            <div class="workSub">
              <div class="tagRow">
                <span class="pill">Year ${escapeHtml(w.year)}</span>
                <span class="pill">Order ${escapeHtml(w.order)}</span>
                <span class="pill">${escapeHtml(w.tier)}</span>
                <span class="pill">Notes ${escapeHtml(noteCount)}</span>
              </div>
              ${subLines.length ? `<div>${subLines.map(escapeHtml).join("<br>")}</div>` : ""}
            </div>
          </div>

          <div class="workActions">
            <button class="btn" type="button" data-action="newNoteFromWork">New note</button>
            <button class="btn" type="button" data-action="openNotesForBook">Open notes</button>
          </div>
        </div>
      `;
    }

    /* =========================================================
       UI WIRING: MAIN CONTROLS
       ========================================================= */
    function wireUI(){
      $("#q").addEventListener("input", e => { state.filters.q = e.target.value; renderAll(); });
      $("#yearSel").addEventListener("change", e => { state.filters.year = e.target.value; renderAll(); });
      $("#tierSel").addEventListener("change", e => { state.filters.tier = e.target.value; renderAll(); });
      $("#sortSel").addEventListener("change", e => { state.filters.sort = e.target.value; renderAll(); });
      $("#onlyIncomplete").addEventListener("change", e => { state.filters.onlyIncomplete = e.target.checked; renderAll(); });

      $("#expandAllBtn").addEventListener("click", () => {
        state.ui.expandedYears = new Set((state.plan.years || []).map(y=>Number(y.year)));
        renderPlan();
      });
      $("#collapseAllBtn").addEventListener("click", () => {
        state.ui.expandedYears.clear();
        renderPlan();
      });

      $("#resetChecksBtn").addEventListener("click", () => {
        if (!confirm("Reset all checkboxes? This cannot be undone.")) return;
        state.checks = {};
        saveChecks(state.checks);
        renderAll();
      });

      // Notes drawer buttons
      $("#openNotesBtn").addEventListener("click", () => openDrawer());
      $("#closeDrawerBtn").addEventListener("click", () => closeDrawer());
      $("#drawerOverlay").addEventListener("click", () => closeDrawer());
      document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && state.notesUI.open) closeDrawer(); });

      // Notes tools
      $("#noteSearch").addEventListener("input", (e)=>{ state.notesUI.search = e.target.value; renderNotesList(); });
      $("#noteTagFilter").addEventListener("change", (e)=>{ state.notesUI.tag = e.target.value; renderNotesList(); });

      $("#newNoteBtn").addEventListener("click", () => startNewNote({}));
      $("#exportNotesBtn").addEventListener("click", exportNotes);
      $("#importNotesBtn").addEventListener("click", ()=> $("#importFile").click());
      $("#importFile").addEventListener("change", importNotesFile);

      // Editor actions
      $("#saveNoteBtn").addEventListener("click", saveEditorNote);
      $("#deleteNoteBtn").addEventListener("click", deleteEditorNote);
      $("#cancelEditBtn").addEventListener("click", () => hideEditor());
    }

    function wirePlanDelegation(){
      const grid = $("#grid");
      // Avoid stacking multiple listeners by resetting handler each render
      grid.onclick = (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "markBlockDone" || action === "markBlockUndone"){
          const block = btn.closest(".readingBlock");
          if (!block) return;
          const workRows = Array.from(block.querySelectorAll(".workRow"));
          for (const row of workRows){
            const key = row.dataset.workkey;
            state.checks[key] = (action === "markBlockDone");
          }
          saveChecks(state.checks);
          renderAll();
          return;
        }

        if (action === "newNoteFromWork" || action === "openNotesForBook"){
          const row = btn.closest(".workRow");
          if (!row) return;
          const ctx = getWorkContextFromRow(row);

          if (action === "newNoteFromWork"){
            openDrawer();
            startNewNote(ctx);
          } else {
            openDrawer();
            state.notesUI.tag = ctx.book_tag;
            $("#noteTagFilter").value = ctx.book_tag;
            renderNotesList();
          }
          return;
        }
      };

      grid.onchange = (e) => {
        const cb = e.target.closest('input[type="checkbox"][data-action="toggleComplete"]');
        if (!cb) return;
        const row = cb.closest(".workRow");
        const key = row.dataset.workkey;
        state.checks[key] = cb.checked;
        saveChecks(state.checks);
        updateProgressBadge();

        // update notes count pill quickly by rerendering just this year card? simplest full render:
        renderPlan();
      };

      // Track details expand/collapse to remember expanded years
      grid.ontoggle = (e) => {
        const details = e.target;
        if (!details || !details.classList.contains("yearDetails")) return;
        const card = details.closest(".yearCard");
        if (!card) return;
        const year = Number(card.dataset.year);
        if (details.open) state.ui.expandedYears.add(year);
        else state.ui.expandedYears.delete(year);
      };
    }

    function getWorkContextFromRow(row){
      const book = row.dataset.book || "";
      const author = row.dataset.author || "";
      const year = Number(row.dataset.year) || "";
      const selection = row.dataset.selection || "";
      return {
        book_tag: book,
        author,
        year,
        selection
      };
    }

    /* =========================================================
       NOTES DRAWER
       ========================================================= */
    function openDrawer(){
      state.notesUI.open = true;
      $("#drawer").classList.add("open");
      $("#drawerOverlay").classList.add("open");
      $("#drawer").setAttribute("aria-hidden", "false");
      $("#drawerOverlay").setAttribute("aria-hidden", "false");
      renderNotesList();
    }

    function closeDrawer(){
      state.notesUI.open = false;
      $("#drawer").classList.remove("open");
      $("#drawerOverlay").classList.remove("open");
      $("#drawer").setAttribute("aria-hidden", "true");
      $("#drawerOverlay").setAttribute("aria-hidden", "true");
      hideEditor();
    }

    function filteredNotes(){
      const q = normalizeText(state.notesUI.search);
      const tag = state.notesUI.tag;

      let notes = state.notes.slice();

      if (tag !== "all"){
        notes = notes.filter(n => n.book_tag === tag);
      }

      if (q){
        notes = notes.filter(n => {
          const hay = normalizeText(`${n.title} ${n.body} ${n.book_tag} ${n.author} ${n.selection}`);
          return hay.includes(q);
        });
      }

      // newest first
      notes.sort((a,b)=> (b.updated_at || "").localeCompare(a.updated_at || ""));
      return notes;
    }

    function renderNotesList(){
      // Sync dropdown UI for tag filter
      const tagSel = $("#noteTagFilter");
      if (tagSel && tagSel.value !== state.notesUI.tag) tagSel.value = state.notesUI.tag;

      const list = $("#noteList");
      const notes = filteredNotes();

      if (!notes.length){
        list.innerHTML = `
          <div class="noteItem">
            <div class="noteItemHead">
              <p class="noteItemTitle">No notes</p>
              <div class="noteItemMeta"><span>Create one</span></div>
            </div>
            <div class="noteItemPreview">Use “New note” or click “New note” on a reading.</div>
          </div>
        `;
      } else {
        list.innerHTML = notes.map(n => noteItemHtml(n)).join("");
      }

      // note click -> edit
      list.onclick = (e) => {
        const item = e.target.closest("[data-noteid]");
        if (!item) return;
        const id = item.dataset.noteid;
        startEditNote(id);
      };
    }

    function noteItemHtml(n){
      const title = n.title ? escapeHtml(n.title) : "Untitled note";
      const book = n.book_tag ? escapeHtml(n.book_tag) : "—";
      const year = n.year ? `Year ${escapeHtml(n.year)}` : "—";
      const updated = n.updated_at ? new Date(n.updated_at).toLocaleString() : "";
      const preview = (n.body || "").slice(0, 220);

      const pills = [
        `<span class="pill">${book}</span>`,
        `<span class="pill">${year}</span>`,
        n.author ? `<span class="pill">${escapeHtml(n.author)}</span>` : ""
      ].filter(Boolean).join("");

      return `
        <div class="noteItem" data-noteid="${escapeHtml(n.id)}">
          <div class="noteItemHead">
            <p class="noteItemTitle">${title}</p>
            <div class="noteItemMeta">
              <span>${escapeHtml(updated)}</span>
            </div>
          </div>
          <div class="tagRow">${pills}</div>
          <div class="noteItemPreview">${escapeHtml(preview)}${(n.body||"").length>220 ? "…" : ""}</div>
        </div>
      `;
    }

    /* =========================================================
       NOTE EDITOR
       ========================================================= */
    function showEditor(){
      $("#noteEditor").style.display = "grid";
      $("#noteList").style.display = "none";
    }
    function hideEditor(){
      $("#noteEditor").style.display = "none";
      $("#noteList").style.display = "block";
      state.notesUI.editingId = null;
    }

    function startNewNote(ctx){
      // ctx: {book_tag, author, year, selection}
      const id = uid();
      state.notesUI.editingId = id;

      // Pre-fill
      $("#editTitle").value = ctx.book_tag ? `${ctx.book_tag} — ` : "";
      $("#editBookTag").value = ctx.book_tag && state.tagsUniverse.includes(ctx.book_tag) ? ctx.book_tag : (state.tagsUniverse[0] || "");
      $("#editYear").value = ctx.year ? String(ctx.year) : "";
      $("#editAuthor").value = ctx.author || "";
      $("#editSelection").value = ctx.selection || "";
      $("#editBody").value = "";

      $("#editMeta").textContent = "New note — not saved yet.";
      showEditor();
      $("#editTitle").focus();
    }

    function startEditNote(id){
      const n = state.notes.find(x => x.id === id);
      if (!n) return;

      state.notesUI.editingId = id;

      $("#editTitle").value = n.title || "";
      $("#editBookTag").value = n.book_tag && state.tagsUniverse.includes(n.book_tag) ? n.book_tag : (state.tagsUniverse[0] || "");
      $("#editYear").value = n.year ? String(n.year) : "";
      $("#editAuthor").value = n.author || "";
      $("#editSelection").value = n.selection || "";
      $("#editBody").value = n.body || "";

      const meta = `Saved • Created: ${n.created_at ? new Date(n.created_at).toLocaleString() : "—"} • Updated: ${n.updated_at ? new Date(n.updated_at).toLocaleString() : "—"}`;
      $("#editMeta").textContent = meta;

      showEditor();
      $("#editBody").focus();
    }

    function saveEditorNote(){
      const id = state.notesUI.editingId;
      if (!id) return;

      const title = $("#editTitle").value.trim();
      const book_tag = $("#editBookTag").value;
      const year = Number($("#editYear").value) || null;
      const author = $("#editAuthor").value.trim();
      const selection = $("#editSelection").value.trim();
      const body = $("#editBody").value;

      const existingIdx = state.notes.findIndex(n => n.id === id);

      if (existingIdx === -1){
        const note = {
          id,
          title: title || `Note — ${book_tag}`,
          book_tag,
          year,
          author,
          selection,
          body,
          created_at: nowIso(),
          updated_at: nowIso()
        };
        state.notes.unshift(note);
      } else {
        const n = state.notes[existingIdx];
        n.title = title || `Note — ${book_tag}`;
        n.book_tag = book_tag;
        n.year = year;
        n.author = author;
        n.selection = selection;
        n.body = body;
        n.updated_at = nowIso();
      }

      saveNotes(state.notes);

      // Keep filter aligned to saved tag if user is filtering
      if (state.notesUI.tag !== "all" && state.notesUI.tag !== book_tag){
        state.notesUI.tag = book_tag;
        $("#noteTagFilter").value = book_tag;
      }

      renderNotesList();
      hideEditor();

      // Update plan pills showing note counts
      renderPlan();
    }

    function deleteEditorNote(){
      const id = state.notesUI.editingId;
      if (!id) return;
      if (!confirm("Delete this note?")) return;

      state.notes = state.notes.filter(n => n.id !== id);
      saveNotes(state.notes);

      renderNotesList();
      hideEditor();
      renderPlan();
    }

    /* =========================================================
       NOTES IMPORT/EXPORT
       ========================================================= */
    function exportNotes(){
      const payload = {
        exported_at: nowIso(),
        notes: state.notes
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `reading-notes-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    async function importNotesFile(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        let notesIn = [];
        if (Array.isArray(parsed)) notesIn = parsed;
        else if (parsed && Array.isArray(parsed.notes)) notesIn = parsed.notes;
        else throw new Error("Import must be an array of notes, or { notes: [...] }");

        // Normalize / de-dupe by id
        const existing = new Map(state.notes.map(n => [n.id, n]));
        for (const n of notesIn){
          if (!n || !n.id) continue;
          existing.set(n.id, {
            id: String(n.id),
            title: String(n.title || "").trim() || `Note — ${String(n.book_tag || "Unknown")}`,
            book_tag: String(n.book_tag || "").trim(),
            year: (n.year === null || n.year === undefined || n.year === "") ? null : Number(n.year),
            author: String(n.author || "").trim(),
            selection: String(n.selection || "").trim(),
            body: String(n.body || ""),
            created_at: n.created_at ? String(n.created_at) : nowIso(),
            updated_at: n.updated_at ? String(n.updated_at) : nowIso()
          });
        }

        state.notes = Array.from(existing.values()).sort((a,b)=> (b.updated_at||"").localeCompare(a.updated_at||""));
        saveNotes(state.notes);

        // Reset file input
        $("#importFile").value = "";

        renderAll();
        alert("Notes imported.");
      } catch(err){
        alert(`Import failed: ${err.message}`);
      }
    }

    /* =========================================================
       BOOT
       ========================================================= */
    loadPlan();
  </script>
</body>
</html>
